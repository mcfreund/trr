---
title: "Updated figures for draft of TRR manuscript"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_depth: 3 
        toc_float: true
        number_sections: true
        df_print: paged
        code_folding: hide
params:
  roi_obj: "top_t"
---



```{r setup, results = FALSE, message = FALSE, echo = FALSE, warning = FALSE}


if (!interactive()) {
  rmarkdown::render(
    input = here::here("code", "inferential", "viz", "figs_ms_2023-05-31.rmd"),
    output_file = here::here("reports", "figs_ms_2023-05-31.html")
    )
  params <- list(roi_obj = "top_t")
}

library(here)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
library(data.table)
library(brms)
library(posterior)
library(colorspace)
library(knitr)
library(mfutils)
library(ggsegSchaefer)
library(purrr)
library(furrr)
library(patchwork)

source(here("code", "_funs.R"))
source(here("code", "_constants.R"))
source(here("code", "inferential", "_plotting.R"))


## plot settings

opts_chunk$set(out.width = "100%")
theme_set(theme_minimal(base_size = 12))
theme_update(
  strip.background = element_rect(fill = "transparent", color = "transparent"),
  axis.line.y.left = element_line(),
  axis.line.x.bottom = element_line(),
  axis.ticks = element_line(),
  panel.grid = element_blank()
  )
axis_text_x_angle <- 30

legend_network8 <- data.frame(
  network = c("Cont", "Default", "DorsAttn", "SalVentAttn", "SomMot", "Temp", "Vis", "Limbic"),
  color = c(qualitative_hcl(7, palette = "Dark 3"), "grey50"),
  label = c(
    "Cont", "\nDefault", "\n\nDorsAttn", "\n\n\nSalVentAttn", "\n\n\n\nSomMot", "\n\n\n\n\nTemp", "\n\n\n\n\n\nVis",
    "\n\n\n\n\n\n\nLimbic"
    ),
    stringsAsFactors = FALSE
)
colors_network8 <- setNames(legend_network8$color, legend_network8$network)
colors_response <- setNames(diverging_hcl(10, palette = "Purple-Brown")[c(2, 9)], c("rda", "uv"))
colors_models <- c(summarystat = "grey40", no_lscov_symm = "firebrick")
colors_nois <- c(
  ContA = "firebrick", ContB = "firebrick", DorsAttnA = "firebrick",
  DorsAttnB = "firebrick", other = "grey60"
  )
example_rois <- c(
    "17Networks_LH_ContA_PFCl_2",
    "17Networks_LH_ContA_IPS_4"
  )
example_roi_names <- c(
  `17Networks_LH_ContA_PFCl_2` = "left PFCl_2",
  `17Networks_LH_ContA_IPS_4` = "left IPS_4"
  )

## other constants, paths, etc...

n_cores <- 30
plan(multicore, workers = n_cores)

responses <- c("rda", "uv")
models <- c("full", "no_lscov", "no_lscov_symm", "fixed_sigma", "summarystat")
models_hbm <- c("full", "no_lscov", "no_lscov_symm", "fixed_sigma")
atlas_nm <- "schaefer2018_17_400_fsaverage5"
roi_col <- "parcel"  ## "parcel" or "network"
rois <- mfutils::schaefer2018_17_400_fsaverage5$key[[roi_col]]
core32 <- rois[core32]  ## replace indices with names
dmcc35 <- rois[dmcc35]

path_out <- file.path("/data/nil-external/ccp/chenr/trr", "out")
model_info <- expand.grid(model_nm = "no_lscov_symm", response = responses, roi_nm = rois, session = sessions)
path_figs <- here("figs", "ms_2023-05-31", params$roi_obj)
dir.create(path_figs, recursive = TRUE, showWarnings = FALSE)

```


```{r, cache = TRUE}

## read data for summarystat model, subset relevant rows/cols, get subject-level stats:

d_summarystat <-
  fread(file.path(path_out, "spatial", "projections__stroop__rda__n_resamples100__demean_run__cv_allsess.csv")) %>%
  rename(ridge = value.ridge, rda = value.rda, session = test_session)
cols_keep <- c("roi", "uv", "rda", "variable", "trial", "subj", "wave", "session")
d_summarystat <- na.omit(d_summarystat[, ..cols_keep])
s_summarystat_subj <- d_summarystat[,
  lapply(.SD, mean),
  by = c("variable", "subj", "wave", "roi", "session"),
  .SDcols = responses
  ]

## read already-summarized data, inc. model comparison stats and diagnostics

misc <-
  readRDS(file.path(path_out, "inferential", atlas_nm, "core32_stats.rds")) %>%
  bind_rows(.id = "model__response__session") %>%
  separate(model__response__session, c("model", "response", "session"), sep = "__") %>%
  filter(session == "baseline") %>%
  mutate(model = factor(model, .env$models, ordered = T)) %>%
  arrange(model, region) %>%
  rename(roi_nm = region, model_nm = model)

```


# z-scored univariate population effects

- To define the z-score, I scaled the mean population hi-lo effect by its standard deviation across subjects (estimated as a subject-level variance component).
  - I did this separately per wave, then averaged across waves per parcel.
  - The first method I tried didn't work well. I first tried scaling each posterior sample of the mean by the SD, per sample of the posterior.
  However a fair number of samples in some regions had very small SDs, so the z-score blew up when doing it this way.
  Instead I summarized over posterior samples, then calculated the z-score.

I defined ROIs using a percentage threshold: top 10% (40 parcels)


```{r, cache = TRUE}

## get z-values:
smrz <- function(x) {
  res <- data.table(
    est_mean = colMeans(x),
    est_median = apply(x, 2, median),
    est_sd = apply(x, 2, sd)
  )
  res$param <- colnames(x)
  res
}

nms <- c("hilo_wave1", "hilo_wave2")

## `div` method: extract posterior samples, compute z-scores per sample, then summarize over samples
s_pop_z_div <- future_pmap_bind(
  CJ(model_nm = "no_lscov_symm", response = "uv", roi_nm = rois, session = "baseline"),
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x, hyp) {
    sd_subj <- VarCorr(x, summary = FALSE)$subj$sd[, nms]
    sd_trial <- exp(fixef(x, summary = FALSE)[, paste0("sigma_", nms)])
    m <- fixef(x, summary = FALSE)[, nms]
    l <- list(pop_mean = m, sd_subj = sd_subj, sd_trial = sd_trial, z_subj = m / sd_subj, z_trial = m / sd_trial)
    rbindlist(lapply(l, smrz), idcol = "term")
    }
  )

## `div` method: extract posterior samples, summarize over samples, then compute z-scores with summary stats
s_pop_z_sum <- future_pmap_bind(
  CJ(model_nm = "no_lscov_symm", response = "uv", roi_nm = rois, session = "baseline"),
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x, hyp) {
    m <- colMeans(fixef(x, summary = FALSE)[, nms])
    sd_subj <- exp(colMeans(log(VarCorr(x, summary = FALSE)$subj$sd[, nms])))
    sd_trial <- exp(colMeans(fixef(x, summary = FALSE)[, paste0("sigma_", nms)]))
    res <- data.table(rbind(m, sd_subj, sd_trial, m / sd_subj, m / sd_trial))
    res$term <- c("pop_mean", "sd_subj", "sd_trial", "z_subj", "z_trial")
    melt(res, value.name = "est_mean", id.vars = "term", variable.name = "param")
    }
  )
s_pop_z <- full_join(
  s_pop_z_div %>% mutate(term = paste0(term, "_div")),
  s_pop_z_sum %>% mutate(term = paste0(term, "_sum"))
)

## add t-stat
s_pop_z <- full_join(
  s_pop_z[term == "pop_mean_div"] %>%
    mutate(est_mean = est_mean / est_sd, term = "pop_tstat_div", est_median = NA, est_sd = NA),
  s_pop_z
)

## average over waves:
s_pop_z_mean <- s_pop_z[, .(est_mean = mean(est_mean)), by = c("roi_nm", "term")]

```

## relation between z-score, t-stat, and other measures

```{r}

## mean, sd_trial, sd_subj

s_pop_z %>%
  filter(
    term %in% c("pop_tstat_div", "pop_mean_div", "sd_subj_sum", "sd_trial_sum", "z_subj_sum", "z_trial_sum")
    ) %>%
  mutate(est_mean1 = est_mean, term = gsub("_div|_sum", "", term)) %>%
  pivot_wider(id_cols = c("roi_nm", "param"), names_from = term, values_from = est_mean) %>%
  filter(param == "hilo_wave1") %>% 
  select(-roi_nm, -param) %>%
  mutate(sd_subj = log(sd_subj), sd_trial_sum = log(sd_trial)) %>%
  pairs(main = "hilo contrast wave1")

p_hilo_scatter <- 
(s_pop_z %>% 
  filter(term %in% c("z_subj_sum")) %>%
  dcast(... ~ param, value.var = "est_mean") %>%
  ggplot(aes(hilo_wave1, hilo_wave2)) +
  geom_point(shape = 21, fill = "transparent") +
  labs(title = "z-score (mean/sd(subj))")) +
(s_pop_z %>% 
  filter(term %in% c("pop_tstat_div")) %>%
  dcast(... ~ param, value.var = "est_mean") %>%
  ggplot(aes(hilo_wave1, hilo_wave2)) +
  geom_point(shape = 21, fill = "transparent") +
  labs(title = "t-stat (mean/se(mean))")) +
(s_pop_z %>% 
  filter(term %in% c("pop_mean_div")) %>%
  dcast(roi_nm ~ param, value.var = "est_mean") %>%
  ggplot(aes(hilo_wave1, hilo_wave2)) +
  geom_point(shape = 21, fill = "transparent") +
  labs(title = "mean"))

p_hilo_scatter

p_stat_scatter <- (s_pop_z %>% 
  filter(term %in% c("pop_mean_div", "pop_tstat_div")) %>%
  dcast(roi_nm + param ~ term, value.var = "est_mean") %>%
  ggplot(aes(pop_mean_div, pop_tstat_div)) +
  geom_point(shape = 21, fill = "transparent") +
  facet_grid(rows = vars(param)) +
  labs(title = "mean versus t-stat")) |
(s_pop_z %>% 
  filter(term %in% c("z_subj_sum", "pop_tstat_div")) %>%
  dcast(roi_nm + param ~ term, value.var = "est_mean") %>%
  ggplot(aes(z_subj_sum, pop_tstat_div)) +
  geom_point(shape = 21, fill = "transparent") +
  facet_grid(rows = vars(param)) +
  labs(title = "z-score versus t-stat")) |
(s_pop_z %>% 
  filter(term %in% c("z_subj_sum", "pop_mean_div")) %>%
  dcast(roi_nm + param ~ term, value.var = "est_mean") %>%
  ggplot(aes(z_subj_sum, pop_mean_div)) +
  geom_point(shape = 21, fill = "transparent") +
  facet_grid(rows = vars(param)) +
  labs(title = "z-score versus mean"))

p_stat_scatter


```


## z-scores

```{r}

s_pop_z_brain <- s_pop_z_mean[term == "z_subj_sum"] %>%
  arrange(-est_mean) %>%
  mutate(is_roi = row_number() <= 40) %>%
  rename(region = "roi_nm", value = est_mean)

p_pop_z_unthresh <- 
  s_pop_z_brain %>%
  ggplot() +
  geom_brain(
    aes(fill = value),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(-3, 0, 3)) +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  labs(fill = "z")

p_pop_z_thresh <-
  s_pop_z_brain %>%
  ggplot(aes(fill = value)) +
  geom_brain(
    aes(fill = ifelse(is_roi, value, as.numeric(NA))),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(2, 2.5, 3)) +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  labs(fill = "z")

p_pop_z <- p_pop_z_unthresh / p_pop_z_thresh
p_pop_z

```

## t-stats

This seems a bit better to me.
While the units of z-score may be more intuitive than t-statistic, I think the t-statistic makes more conceptual sense in our case.
It shows the the effect size relative to the overall uncertainty in the effect size---which (I am pretty sure) integrates the influence of both trial and subject-level variability.

```{r}

s_pop_t_brain <- s_pop_z_mean[term == "pop_tstat_div"] %>%
  arrange(-est_mean) %>%
  mutate(is_roi = row_number() <= 40) %>%
  rename(region = "roi_nm", value = est_mean)

p_pop_t_unthresh <- 
  s_pop_t_brain %>%
  ggplot() +
  geom_brain(
    aes(fill = value),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(-3, 0, 6)) +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  labs(fill = "t")

p_pop_t_thresh <-
  s_pop_t_brain %>%
  ggplot(aes(fill = value)) +
  geom_brain(
    aes(fill = ifelse(is_roi, value, as.numeric(NA))),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(4, 5, 6)) +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  labs(fill = "t")

p_pop_t <- p_pop_t_unthresh / p_pop_t_thresh
p_pop_t

```


## SD over subjects (z-score denom.)

Shown is the SD in the hi-lo effect over subjects, averaged across waves.
Note that there's quite a bit of variability in FPN parcels, particularly within IPS/PPC, which also have among the strongest univariate effects.
Thus it's not clear to me that we want to use this to standardize the mean effects, because the across-subject SD in hi-lo contrast is really a signal that we're interested in. 


```{r}

## sd over subjs:

s_pop_sd_subj <- s_pop_z_mean[term == "sd_subj_sum"] %>%
  mutate(
    is_roi = roi_nm %in% (
        s_pop_z[term == "sd_subj_sum", .(est_mean = mean(est_mean)), by = "roi_nm"] %>%
        slice_max(order_by = est_mean, n = 40) %>%
        pull(roi_nm))
    ) %>%
  rename(region = "roi_nm", value = est_mean)

p_pop_sd_subj_unthresh <- 
  s_pop_sd_subj %>%
  ggplot() +
  geom_brain(
    aes(fill = value),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(0.01, 0.05, 0.09), trans = "log") +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9, title.hjust = 1)) +
  labs(fill = "SD\n(log scale)")

p_pop_sd_subj_thresh <-
  s_pop_sd_subj %>%
  ggplot() +
  geom_brain(
    aes(fill = ifelse(is_roi, value, as.numeric(NA))),
    color = "black",
    atlas = atlas, position = position_brain(. ~ hemi + side)
    ) +
  scale_fill_viridis_c(option = "magma", na.value = "white", breaks = c(0.06, 0.08, 0.1), trans = "log") +
  theme_surface +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.1)) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9, title.hjust = 1)) +
  labs(fill = "SD\n(log scale)")

p_pop_sd_subj <- p_pop_sd_subj_unthresh / p_pop_sd_subj_thresh
p_pop_sd_subj

```


```{r}
ggsave(file.path(path_figs, "brain_pop_z.pdf"), p_pop_z, height = 2, width = 4.5)
ggsave(file.path(path_figs, "brain_pop_sd_subj.pdf"), p_pop_sd_subj, height = 2, width = 4.5)
ggsave(file.path(path_figs, "brain_pop_t.pdf"), p_pop_t, height = 2, width = 4.5)

```


## ROIs: z-score versus t-stat

```{r}

top_z <- s_pop_z_brain[is_roi == TRUE, region]
top_t <- s_pop_t_brain[is_roi == TRUE, region]

table_rois_z <- data.table(
  name = top_z,
  z = s_pop_z_brain[is_roi == TRUE, value],
  num = match(top_z, rois),
  unique = !top_z %in% top_t
)

table_rois_t <- data.table(
  name = top_z,
  t = s_pop_t_brain[is_roi == TRUE, value],
  num = match(top_z, rois),
  unique = !top_t %in% top_z
)

```

Top 40 z-stats (`unique` column indicates ROIs that are NOT also within the top 40 t-stats):
```{r}
print(table_rois_z[order(-z)])
```

Top 40 t-stats (`unique` column indicates ROIs that are NOT also within the top 40 z-stats):
```{r}
print(table_rois_t[order(-t)])
```









# univariate: HBM vs summarystat | ROI status

```{r, cache = TRUE}

## get summarystat model ests:
s_summarystat_subj_trr <- s_summarystat_subj %>%
  pivot_longer(cols = all_of(responses), names_to = "response") %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(hilo = hi - lo) %>%
  pivot_wider(id_cols = c("subj", "roi", "response", "session"), names_from = wave, values_from = hilo) %>%
  rename(roi_nm = roi) %>%
  mutate(model_nm = "summarystat")

## get summarystat model ests:
r_summarystat <- s_summarystat_subj_trr %>%
  group_by(roi_nm, model_nm, response, session) %>%
  summarize(r = cor(wave1, wave2)) %>%
  mutate(network = get_network(roi_nm))


## get HBM posteriors:
s_hbm_posterior <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(mdl) {
    mu <- ranef(mdl, summary = FALSE)$subj  ## for conditional TRR
    S <- VarCorr(mdl, summary = FALSE)$subj  ## for marginal TRR
    if ("sd_subj__hilo_wave1" %in% variables(mdl)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
      trr <- S$cor[, "hilo_wave1", "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
      trr <- NA  ## marginal ranefs not yet implemented for this parameterization
    }
    trr_conditional <- rep(0, dim(mu)[1])
    for (ii in seq_along(trr_conditional)) trr_conditional[ii] <- cor(mu_stroop1[ii, ], mu_stroop2[ii, ])
    stopifnot(length(trr_conditional) == length(trr))
    data.table(trr = trr, trr_conditional = trr_conditional, resample = seq_along(trr))
  }
)

s_hbm_posterior[, network := get_network(roi_nm, TRUE)]

## summarize HBM posterior

s_hbm_posterior_sum <-
  s_hbm_posterior[,
  .(
    trr_map = max_aposteriori(trr),
    trr_mean = mean(trr),
    trr_05 = quantile(trr, 0.05),
    trr_sd = sd(trr)
  ),
  by = c("model_nm", "roi_nm", "response", "network", "session")
  ]
s_hbm_posterior_sum <- melt(
  s_hbm_posterior_sum,
  id.vars = c("model_nm", "roi_nm", "response", "network", "session")
  )

```

## ROIs defined by top 10% of t-stat

```{r}

trr_stats_uv <- full_join(
  s_hbm_posterior_sum %>%
    filter(session == "baseline", variable %in% c("trr_map"), response == "uv") %>%
    ungroup %>%
    select(roi_nm, model_nm, value),
  r_summarystat %>% 
    filter(session == "baseline", response == "uv") %>%
    rename(value = r) %>%
    ungroup %>%
    select(roi_nm, model_nm, value)
  ) %>%
  rename(region = roi_nm)

p_trr_stats_uv <-
  trr_stats_uv %>%
  group_by(model_nm) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = value), atlas = atlas, position = position_brain(. ~ hemi + side), color = "black") +
  scale_fill_viridis_c(
      option = "magma", na.value = "white",
      limits = c(-1, 1),
      breaks = c(-1, 0, 1)
      ) +
  theme_surface +
  facet_grid(
    vars(model_nm),
    labeller = labeller(
      model_nm = c(no_lscov_symm = "HBM MAP", summarystat = "ICC")
      ),
    switch = "y"
    ) +
  theme(
    axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/2),
    strip.text = element_blank(), axis.title = element_blank()
    ) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  geom_text(
    data = data.frame(x = -50, y = 100, label = c("ICC", "HBM-MAP"), model_nm = c("summarystat", "no_lscov_symm")),
    aes(x = x, y = y, label = label),
    size = 5, color = "black", hjust = 0.5, vjust = 0.5, angle = 90
  ) +
  labs(fill = "TRR")

p_delta_trr_line <- trr_stats_uv %>%
  mutate(
    is_roi = region %in% get(params$roi_obj),
    model_nm = ifelse(model_nm == "summarystat", "ICC", "HBM-MAP"),
    model_nm = factor(model_nm, levels = c("ICC", "HBM-MAP"))
  ) %>%
  ggplot(aes(model_nm, value, color = is_roi, fill = is_roi)) +
  geom_line(data = . %>% filter(!is_roi), aes(group = region), alpha = 0.1) +
  geom_point(data = . %>% filter(!is_roi), size = 0.5, alpha = 0.1, shape = 21) +
  geom_line(data = . %>% filter(is_roi), aes(group = region), alpha = 1/3) +
  geom_point(data = . %>% filter(is_roi), size = 0.5, alpha = 1/3, shape = 21) +
  geom_line(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  geom_line(data = . %>% filter(is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  # facet_grid(
  #   cols = vars(is_roi),
  #   labeller = labeller(is_roi = c(`TRUE` = "ROI", `FALSE` = "non-ROI"))
  #   #labeller = labeller(is_roi = c(`TRUE` = "ROI\n%ile(t)<0.1", `FALSE` = "non-ROI\n%ile(t)>0.1"))
  #   ) +
  geom_text(
    data = data.frame(
      label = c("ROI", "\n\nnon-ROI"),
      is_roi = c(TRUE, FALSE),
      x = 1.5,
      y = c(1, -1/2)
      ),
    aes(label = label, x = x, y = y), hjust = 0.5, vjust = 0.5, size = 4) +
  scale_y_continuous(limits = c(-1, 1), breaks = c(-1, 0, 1)) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none"
    ) +
  labs(y = "TRR")

p_delta_trr_t_scatter <- 
  trr_stats_uv %>% 
  mutate(value = atanh(value)) %>%
  pivot_wider(id_cols = region, names_from = model_nm, values_from = value) %>%
  full_join(s_pop_t_brain %>% rename(t_stat = value)) %>%
  mutate(
    trr_diff = no_lscov_symm - summarystat,
    is_roi = region %in% get(params$roi_obj)
    ) %>%
  ggplot(aes(t_stat, trr_diff, color = is_roi, fill = is_roi)) +
  geom_point(data = . %>% filter(is_roi == FALSE), shape = 21, size = 1) +
  geom_point(data = . %>% filter(is_roi == TRUE), shape = 21, size = 1) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.line.y.left = element_blank(),
    legend.position = "none"
    ) +
  labs(
    x = "Mean Stroop eff. (t)",
    y = "\u0394TRR,\nHBM-MAP\u2212ICC\n(atanh(r))"
  )
p_delta_trr_t_scatter

p_delta_trr_scatter <- 
  trr_stats_uv %>% 
  #mutate(value = atanh(value)) %>%
  pivot_wider(id_cols = region, names_from = model_nm, values_from = value) %>%
  mutate(is_roi = region %in% get(params$roi_obj)) %>%
  ggplot(aes(summarystat, no_lscov_symm, color = is_roi, fill = is_roi)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_abline() +
  geom_point(data = . %>% filter(is_roi == FALSE), shape = 21, size = 1) +
  geom_point(data = . %>% filter(is_roi == TRUE), shape = 21, size = 1) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.line.y.left = element_blank(),
    legend.position = "none"
    ) +
  labs(
    x = "ICC TRR (r)",
    y = "HBM TRR (MAP r)"
  )


p_trr_uv <-
  ( p_trr_stats_uv / 
    ((p_delta_trr_line | p_delta_trr_scatter) + plot_layout(widths = c(1.5, 1)))
  ) +
  plot_layout(heights = c(1, 1)) + plot_annotation(tag_levels = list(c("A", "B")))
ggsave(
  file.path(path_figs, "trr_diff_uv.pdf"),
  dev = cairo_pdf, width = 6.5, height = 5.5
  )
p_trr_uv


```




# summary stat: UV vs MV TRR | brains, roi status

```{r}

r_summarystat <- r_summarystat %>% rename(region = "roi_nm")

## get summarystat model ests:

p_trr_icc_uvmv_brain <- r_summarystat %>%
  filter(session == "baseline") %>%
  group_by(response) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = r), atlas = atlas, position = position_brain(. ~ hemi + side), color = "black") +
  scale_fill_viridis_c(
      option = "magma", na.value = "white",
      limits = c(-0.4, 0.9),
      breaks = c(0, 0.9)
      ) +
  theme_surface +
  facet_grid(
    vars(response),
    labeller = labeller(
      response = c(rda = "multiv.", summarystat = "univar.")
      ),
    switch = "y"
    ) +
  theme(
    axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 0.485),
    strip.text = element_blank(), axis.title = element_blank()
    ) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  geom_text(
    data = data.frame(x = -50, y = 100, label = c("multiv.", "univar."), response = c("rda", "uv")),
    aes(x = x, y = y, label = label),
    size = 5, color = "black", hjust = 0.5, vjust = 0.5, angle = 90
  ) +
  labs(fill = "TRR (ICC)")

p_trr_icc_uvmv_line <- r_summarystat %>%
  filter(session == "baseline") %>%
  mutate(
    is_roi = region %in% get(params$roi_obj),
    response = ifelse(response == "rda", "multiv.", "univar."),
    response = factor(response, levels = c("univar.", "multiv."))
    ) %>%
  ggplot(aes(response, r, color = is_roi, fill = is_roi)) +
  geom_line(data = . %>% filter(!is_roi), aes(group = region), alpha = 0.1) +
  geom_point(data = . %>% filter(!is_roi), size = 0.5, alpha = 0.1, shape = 21) +
  geom_line(data = . %>% filter(is_roi), aes(group = region), alpha = 1/3) +
  geom_point(data = . %>% filter(is_roi), size = 0.5, alpha = 1/3, shape = 21) +
  geom_line(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  geom_line(data = . %>% filter(is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  # facet_grid(
  #   cols = vars(is_roi),
  #   labeller = labeller(is_roi = c(`TRUE` = "ROI", `FALSE` = "non-ROI"))
  #   #labeller = labeller(is_roi = c(`TRUE` = "ROI\n%ile(t)<0.1", `FALSE` = "non-ROI\n%ile(t)>0.1"))
  #   ) +
  geom_text(
    data = data.frame(
      label = c("ROI", "\n\nnon-ROI"),
      is_roi = c(TRUE, FALSE),
      x = 1.5,
      y = c(1, -1/2)
      ),
  aes(label = label, x = x, y = y), hjust = 0.5, vjust = 0.5, size = 4) +
  scale_y_continuous(limits = c(-1, 1), breaks = c(-1, 0, 1)) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none"
    ) +
  labs(y = "ICC TRR (r)")


p_trr_icc_uvmv_scatter <- 
  r_summarystat %>%  
  filter(session == "baseline") %>%
  mutate(is_roi = region %in% get(params$roi_obj)) %>%
  pivot_wider(id_cols = c(region, is_roi), names_from = response, values_from = r) %>%
  ggplot(aes(uv, rda, color = is_roi, fill = is_roi)) +
  geom_abline() +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(is_roi == FALSE), shape = 21, size = 1) +
  geom_point(data = . %>% filter(is_roi == TRUE), shape = 21, size = 1) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.line.y.left = element_blank(),
    legend.position = "none"
    ) +
  labs(
    x = "univ. ICC TRR (r)",
    y = "multiv. ICC TRR (r)"
  ) +
  coord_cartesian(xlim = c(-0.5, 1), ylim = c(-0.5, 1))


p_trr_icc_uvmv <-
  (
    p_trr_icc_uvmv_brain / 
    (p_trr_icc_uvmv_line | p_trr_icc_uvmv_scatter) + plot_layout(widths = c(1.5, 1))
  ) +
  plot_layout(heights = c(1, 1)) + plot_annotation(tag_levels = list(c("A", "B")))
ggsave(
  file.path(path_figs, "trr_icc_uvmv.pdf"),
  p_trr_icc_uvmv,
  dev = cairo_pdf, width = 6.5, height = 5.5
  )
p_trr_icc_uvmv


```






# 1/SD(TRR)

```{r}

s_hbm_posterior_sum <- s_hbm_posterior_sum %>% rename(region = "roi_nm")

s_hbm_posterior_sum %>%
  filter(session == "baseline", variable == "trr_sd") %>%
  mutate(value = value^-1) %>% pull(value) %>% range

p_trr_sd_uvmv_brain <- s_hbm_posterior_sum %>%
  filter(session == "baseline", variable == "trr_sd") %>%
  group_by(response) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = value^-1), atlas = atlas, position = position_brain(. ~ hemi + side), color = "black") +
  scale_fill_viridis_c(
      option = "magma", na.value = "white", trans = "log",
      limits = c(1.6, 14),
      breaks = c(2, 8, 14)
      ) +
  theme_surface +
  facet_grid(
    vars(response),
    labeller = labeller(
      response = c(rda = "multiv.", summarystat = "univar.")
      ),
    switch = "y"
    ) +
  theme(
    axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 0.485),
    strip.text = element_blank(), axis.title = element_blank()
    ) +
  guides(fill = guide_colorbar(title.position = "left", title.vjust = 0.9)) +
  geom_text(
    data = data.frame(x = -50, y = 100, label = c("multiv.", "univar."), response = c("rda", "uv")),
    aes(x = x, y = y, label = label),
    size = 5, color = "black", hjust = 0.5, vjust = 0.5, angle = 90
  ) +
  labs(fill = "Prcsn.(TRR)\n(log scale)")

p_trr_sd_uvmv_line <- s_hbm_posterior_sum %>%
  filter(session == "baseline", variable == "trr_sd") %>%
  mutate(
    is_roi = region %in% get(params$roi_obj),
    response = ifelse(response == "rda", "multiv.", "univar."),
    response = factor(response, levels = c("univar.", "multiv."))
    ) %>%
  ggplot(aes(response, 1/value, color = is_roi, fill = is_roi)) +
  geom_line(data = . %>% filter(!is_roi), aes(group = region), alpha = 0.1) +
  geom_point(data = . %>% filter(!is_roi), size = 0.5, alpha = 0.1, shape = 21) +
  geom_line(data = . %>% filter(is_roi), aes(group = region), alpha = 1/3) +
  geom_point(data = . %>% filter(is_roi), size = 0.5, alpha = 1/3, shape = 21) +
  geom_line(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(!is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  geom_line(data = . %>% filter(is_roi), stat = "summary", fun = "mean", aes(group = is_roi)) +
  geom_point(data = . %>% filter(is_roi), stat = "summary", fun = "mean", size = 4, color = "white", shape = 21) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  # facet_grid(
  #   cols = vars(is_roi),
  #   labeller = labeller(is_roi = c(`TRUE` = "ROI", `FALSE` = "non-ROI"))
  #   #labeller = labeller(is_roi = c(`TRUE` = "ROI\n%ile(t)<0.1", `FALSE` = "non-ROI\n%ile(t)>0.1"))
  #   ) +
  geom_text(
    data = data.frame(
      label = c("ROI", "\n\nnon-ROI"),
      is_roi = c(TRUE, FALSE),
      x = 1.5,
      y = c(14, 2)
      ),
  aes(label = label, x = x, y = y), hjust = 0.5, vjust = 0.5, size = 4) +
  scale_y_continuous(limits = c(1.6, 14), breaks = c(2, 6, 10, 14), trans = "log") +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none"
    ) +
  labs(y = "Precision(TRR)\n(log scale)")


p_trr_sd_uvmv_scatter <-
  s_hbm_posterior_sum %>%
  filter(session == "baseline", variable == "trr_sd") %>%
  mutate(is_roi = region %in% get(params$roi_obj), value = 1/value) %>%
  pivot_wider(id_cols = c(region, is_roi), names_from = response, values_from = value) %>%
  ggplot(aes(uv, rda, color = is_roi, fill = is_roi)) +
  geom_abline() +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point(data = . %>% filter(is_roi == FALSE), shape = 21, size = 1) +
  geom_point(data = . %>% filter(is_roi == TRUE), shape = 21, size = 1) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.line.y.left = element_blank(),
    legend.position = "none"
    ) +
  labs(
    x = "univ. Precision(TRR)\n(log scale)",
    y = "multiv. Precision(TRR)\n(log scale)"
  ) +
  scale_y_continuous(limits = c(1.6, 14), breaks = c(2, 6, 10, 14), trans = "log") +
  scale_x_continuous(limits = c(1.6, 14), breaks = c(2, 6, 10, 14), trans = "log")


p_trr_sd_uvmv <-
  (
    p_trr_sd_uvmv_brain / 
    ((p_trr_sd_uvmv_line | p_trr_sd_uvmv_scatter) + plot_layout(widths = c(1.5, 1)))
    ) +
  plot_layout(heights = c(1, 1)) + plot_annotation(tag_levels = list(c("A", "B")))
ggsave(
  file.path(path_figs, "trr_sd_uvmv.pdf"),
  p_trr_sd_uvmv,
  dev = cairo_pdf, width = 6.5, height = 5.5
  )
p_trr_sd_uvmv

```



# contingency table: model-type versus response-type

```{r}

d_tab <- full_join(
  s_hbm_posterior_sum %>%
    filter(session == "baseline", variable == "trr_sd") %>%
    mutate(value = log(1/value)) %>%
    pivot_wider(id_cols = region, names_from = response, values_from = value) %>%
    mutate(lr = rda - uv),
  trr_stats_uv %>%  
    mutate(value = atanh(value)) %>%
    pivot_wider(id_cols = region, names_from = model_nm, values_from = value) %>%
    mutate(trr_diff = no_lscov_symm - summarystat),
    by = "region"
  ) %>%
  full_join(s_pop_t_brain %>% rename(t_stat = value), by = "region") %>%  ## fix THIS LINE
  mutate(trrsd_response = lr > 0, trr_model = trr_diff > 0)

p_tab <-
  d_tab %>%
  mutate(
    trrsd_response = ifelse(trrsd_response, "multiv. > univar.", "multiv. < univar."),
    trr_model = ifelse(trr_model, "HBM > ICC", "HBM < ICC")
    ) %>%
  group_by(trrsd_response, trr_model) %>%
  summarise(n = n()) %>%
  ggplot(aes(trrsd_response, trr_model, fill = n)) +
  geom_tile() +
  geom_text(aes(label = n), size = 4) +
  scale_fill_continuous_sequential(palette = "Reds") +
  theme(
    axis.line.x.bottom = element_blank(),
    axis.line.y.left = element_blank(),
    axis.text.y = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
    panel.border = element_rect(fill = "transparent"),
    legend.position = "none"
    ) +
  labs(x = "Precision(TRR)", y = "univar. TRR")

# d_tab %>%
#   mutate(
#     trrsd_response = ifelse(trrsd_response, "multiv. > univar.", "multiv. < univar."),
#     trr_model = ifelse(trr_model, "HBM > ICC", "HBM < ICC")
#     ) %>%
#   filter(is_roi) %>%
#   group_by(trrsd_response, trr_model) %>%
#   summarise(n = n())

d_tab %>%
  ggplot(aes(lr, trr_diff, color = t_stat, fill = t_stat)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)  +
  geom_point(shape = 21, size = 3) +
  scale_color_viridis_c(option = "magma") +
  scale_fill_viridis_c(option = "magma") +
  labs(x = "\u0394Precision(TRR), multiv.\u2212univ.\n(log ratio)", y = "\u0394TRR (univar.), HBM-MAP\u2212ICC\n(atanh(r))")

## example densities:

if (FALSE) {  ## for choosing example regions
  examples <- list(
    tt = d_tab %>% filter(lr > 0.75, trr_diff > 0.5) %>% pull(region),
    tf = d_tab %>% filter(lr > 0.5, lr < 0.7, trr_diff < -0.5) %>% pull(region),
    ft = d_tab %>% filter(lr < -0.4, lr > -0.7) %>% pull(region),
    ff = d_tab %>% filter(lr < -0.05, trr_diff < -0.8) %>% pull(region)
  )
  s_hbm_posterior[roi_nm %in% examples[["tt"]] & session == "baseline"] %>%
    rename(region = roi_nm) %>%
    ggplot(aes(trr, color = response, fill = response)) +
    geom_density(size = 1.5, aes(fill = NULL, group = response)) +
    facet_wrap(
      vars(gsub("17Networks_", "", region)), ncol = 4, scales = "free"
      ) +
    scale_color_manual(values = colors_response) +
    scale_fill_manual(values = colors_response) +
    theme(legend.position = "none") +
    labs(x = "TRR", y = "posterior density")
}

eg <- list(
  ft = c(
    "(a1)\n FPN-B PFCd1" = "17Networks_LH_ContB_PFCd_1",
    "(a2)\n DAN-A SPL4" = "17Networks_LH_DorsAttnA_SPL_4"
    # "17Networks_LH_SalVentAttnB_Ins_2",
    # "17Networks_RH_VisCent_ExStr_2"
  ),
  tt =  c(
    "(b1)\n FPN-A PFCd1" = "17Networks_LH_ContA_PFCd_1",
    "(b2)\n DAN-A SPL7" = "17Networks_LH_DorsAttnA_SPL_7"
    # "17Networks_LH_DorsAttnB_FEF_2",
    # "17Networks_RH_ContA_IPS_1"
  ),
  ff =  c(
    "(c1)\n SMN-A 10" = "17Networks_LH_SomMotA_10",
    "(c2)\n Limbic-B OFC4" = "17Networks_LH_LimbicB_OFC_4"
    # "17Networks_RH_SomMotA_5",
    # "17Networks_RH_LimbicB_OFC_6"
  ),
  tf =  c(
    "(d1)\n SMN-B Aud1" = "17Networks_LH_SomMotB_Aud_1",
    "(d2)\n DMN-B IPL2" = "17Networks_LH_DefaultB_IPL_2"
    # "17Networks_RH_VisCent_ExStr_4",
    # "17Networks_RH_DefaultA_PFCm_3"
  )
)


th <- list(
  tt = list(
      theme(
        axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(),
        axis.title.y = element_blank(), axis.title.x = element_blank(),
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        axis.text.x = element_blank(), axis.ticks.x = element_blank()
        ),
    geom_text(
      data = data.frame(
        nms = "(b2)\n DAN-A SPL7", trr = -Inf, y = Inf, label = c("univar.", "\nmultiv."),
        response = c("uv", "rda"), stringsAsFactors = FALSE
        ),
      aes(label = label, y = y), vjust = 1, hjust = 0, size = 4
    )
  ),
  ft = theme(
    axis.line.y.left = element_blank(),
    axis.line.x.bottom = element_blank(), axis.title.x = element_blank(),
    axis.text.x = element_blank(), axis.ticks.x = element_blank(),
    axis.text.y = element_blank(), axis.ticks.y = element_blank(),
    ),
  tf = theme(
    axis.line.y.left = element_blank(), axis.title.y = element_blank(),
    axis.line.x.bottom = element_blank(),
    axis.text.y = element_blank(), axis.ticks.y = element_blank()
    ),
  ff = theme(
    axis.line.y.left = element_blank(),
    axis.line.x.bottom = element_blank(),
    axis.text.y = element_blank(), axis.ticks.y = element_blank()
  )
)

l_density <- enlist(names(eg))
for (i in seq_along(eg)) {
  p <- s_hbm_posterior[roi_nm %in% eg[[i]] & session == "baseline"] %>%
    rename(region = roi_nm) %>%
    ggplot(aes(trr, color = response, fill = response)) +
    geom_hline(yintercept = 0) +
    geom_density(size = 1.5, aes(fill = NULL, group = response)) +
    geom_vline(
      data =
        r_summarystat %>%
          filter(region %in% eg[[i]] & session == "baseline") %>%
          select(region, r, model_nm, response) %>%
          mutate(nms = setNames(names(eg[[i]]), eg[[i]])[region]),
      aes(xintercept = r, color = response),
      linetype = "dotted", linewidth = 1
      ) +
    facet_wrap(
      vars(nms),
      #vars(gsub("17Networks_", "", region)),
      ncol = 2,
      scales = "free_y"
      ) +
    #geom_text(data = response_labs, aes(x = -0.9, y = 6, label = label), size = 5, hjust = 0, fontface = "bold") +
    scale_color_manual(values = colors_response) +
    scale_fill_manual(values = colors_response) +
    theme(legend.position = "none", strip.text = element_text(size = 6), axis.title.y = element_blank()) +
    labs(x = "TRR", y = "posterior density") + #, title = letters[i]
    scale_x_continuous(limits = c(-1, 1), breaks = c(-1, 0, 1)) +
    scale_y_continuous(breaks = 0) +
    th[[names(eg)[i]]]

  l_density[[i]] <- p

}

p_densities <-
  (l_density$ft | l_density$tt) /
  (l_density$ff | l_density$tf)

eg_inv <- setNames(c(vapply(eg, names, character(2))), unlist(eg))

p_eg_scatter <- d_tab %>%
  ggplot(aes(lr, trr_diff, color = is_roi, fill = is_roi)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)  +
  geom_text(
    data = . %>%
      mutate(
        trrsd_response = ifelse(trrsd_response, "multiv. > univar.", "multiv. < univar."),
        trr_model = ifelse(trr_model, "HBM > ICC", "HBM < ICC")
        ) %>%
      group_by(trrsd_response, trr_model) %>%
      summarise(n = n()) %>%
      mutate(
        quad = case_when(
          trrsd_response == "multiv. < univar." & trr_model == "HBM > ICC" ~ "a",
          trrsd_response == "multiv. > univar." & trr_model == "HBM > ICC" ~ "b",
          trrsd_response == "multiv. < univar." & trr_model == "HBM < ICC" ~ "c",
          trrsd_response == "multiv. > univar." & trr_model == "HBM < ICC" ~ "d"
          ),
        lab = quad,
        #lab = paste0(quad, " (N=", n, ")"),
        lr = ifelse(trrsd_response == "multiv. > univar.", 1.3, -1.3),
        hjust = ifelse(trrsd_response == "multiv. > univar.", 1, 0),
        trr_diff = ifelse(trr_model == "HBM > ICC", 1.5, -1.5),
        vjust = ifelse(trr_model == "HBM > ICC", 1, 0),
        is_roi = FALSE
      ),
    aes(label = lab, hjust = hjust, vjust = vjust), size = 5
    #aes(label = paste0(trrsd_response, ", ", trr_model, ": ", n)),
    ) +
  geom_point(data = . %>% filter(is_roi == FALSE), shape = 21, size = 1.25) +
  geom_point(data = . %>% filter(is_roi == TRUE), shape = 21, size = 1.25) +
  geom_text(
    data = . %>% filter(region %in% unlist(eg)) %>% mutate(nms = substr(eg_inv[region], 1, 5)),
    aes(label = nms), size = 2, hjust = 0, vjust = 1, nudge_y = 0.0, nudge_x = 0.0) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  scale_x_continuous(limits = c(-1.4, 1.4), breaks = c(-1, -0.5, 0, 0.5, 1)) +
  scale_y_continuous(limits = c(-1.5, 1.5), breaks = c(-1, -0.5, 0, 0.5, 1)) +
  labs(
    x = "\u0394Precision(TRR), multiv.\u2212univ.\n(log ratio)",
    y = "\u0394TRR (univar.), HBM-MAP\u2212ICC\n(atanh(r))"
    ) +
  theme(legend.position = "none")

p_eg <- (p_eg_scatter + p_densities) + plot_layout(widths = c(1, 1.2))

p_eg

ggsave(
  file.path(path_figs, "trr_eg.pdf"),
  p_eg,
  dev = cairo_pdf, width = 9, height = 5, scale = 0.8
  )

```




# variability ratio versus precision: univar. versus multiv.

```{r, cache = TRUE}

## get variability ratio:

s_hbm_subj_ratio <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x) {
    ranefs <- ranef(x, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(x)) {
      stroop1 <- ranefs[, , "hilo_wave1"]
      stroop2 <- ranefs[, , "hilo_wave2"]
      if ("b_sigma_Intercept" %in% variables(x))  {
        hyp <- "exp(sigma_Intercept) = 0"
      } else {
        hyp <- "exp((sigma_mean_wave1 + sigma_mean_wave2) / 2) = 0"
      }
    } else {
      stroop1 <- ranefs[, , "hi_wave1"] - ranefs[, , "lo_wave1"]
      stroop2 <- ranefs[, , "hi_wave2"] - ranefs[, , "lo_wave2"]
      hyp <- "exp((sigma_hi_wave1 + sigma_hi_wave2 + sigma_lo_wave1 + sigma_lo_wave2) / 4) = 0"
    }
    sigma_stroop1 <- sqrt(Var(stroop1, 1))
    sigma_stroop2 <- sqrt(Var(stroop2, 1))
    sigma_stroop <- (sigma_stroop1 + sigma_stroop2)/2
    sigma_resid <- hypothesis(x, hyp)$samples$H1
    ratio <- sigma_resid / sigma_stroop

    data.table(
      sigma_resid = sigma_resid, 
      sigma_stroop = sigma_stroop, 
      ratio = sigma_resid / sigma_stroop,
      resample = seq_along(ratio)
      )

  }
)

s_hbm_subj_ratio_sum <- s_hbm_subj_ratio[,
  .(ratio = max_aposteriori(ratio)),
  by = c("model_nm", "roi_nm", "response", "session")
  ] %>%
  rename(region = roi_nm, value = ratio) %>% 
  mutate(variable = "ratio", network = get_network(region, TRUE))

s_hbm_posterior_sum <- rbind(s_hbm_posterior_sum, s_hbm_subj_ratio_sum)


```


```{r}

p_ratio <-
  s_hbm_posterior_sum[session == "baseline" & variable %in% c("ratio", "trr_sd")] %>%
  mutate(value = log(value), is_roi = region %in% get(params$roi_obj)) %>%
  pivot_wider(names_from = c("variable", "response"), values_from = "value") %>%
  mutate(
    precision_mvuv =  trr_sd_uv - trr_sd_rda,
    variratio_mvuv = ratio_rda - ratio_uv
  ) %>%
  ggplot(aes(variratio_mvuv, precision_mvuv, color = is_roi, fill = is_roi, group = "")) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted")  +
  stat_ellipse(type = "t", linetype = "dotted") +
  geom_abline(slope = -1, linetype = "dotted")  +
  geom_point(data = . %>% filter(!is_roi), shape = 21, size = 1.25) +
  geom_point(data = . %>% filter(is_roi), shape = 21, size = 1.25) +
  scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "firebrick")) +
  scale_fill_manual(values = c(`FALSE` = "transparent", `TRUE` = "firebrick")) +
  labs(
    x = "\u0394Variab. Ratio, multiv.\u2212univ.\n(log ratio)",
    y = "\u0394Precision(TRR), multiv.\u2212univ.\n(log ratio)"
    ) +
  theme(legend.position = "none") +
  geom_text(
    data = . %>%
      summarize(
        r = cor(precision_mvuv, variratio_mvuv),
        rho = cor(precision_mvuv, variratio_mvuv, method = "spearman")
      ) %>%
      mutate(
        label = paste0("r = ", round(r, 2), "\n", "\n\u03C1 = ", round(rho, 2)),
        is_roi = FALSE
        ),
    aes(x = 0.5, y = 0.5, label = label),
  )
  #scale_y_continuous(limits = c(-1.4, 1.4)) +
  #scale_x_continuous(limits = c(-1.3, 1.3))

ggsave(
  file.path(path_figs, "variability_ratio_vs_precision.pdf"),
  p_ratio,
  dev = cairo_pdf, width = 4.5, height = 4, scale = 0.8
  )

p_ratio

```


<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
