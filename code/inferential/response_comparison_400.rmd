---
title: "Univariate vs multivariate comparison on 400 Schaefer atlas parcels: `r params$model`, `r params$session`"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_depth: 3 
        toc_float: true
        number_sections: true
        df_print: paged
        code_folding: hide
params:
  mv: "rda"
  model: "no_lscov_symm"
  session: "reactive"
---

This document summarizes the results of the `r params$model` model fitted to univariate versus multivariate (`r params$mv`) 
outcome variable within the `r params$session` session.


```{r setup, results = FALSE, message = FALSE, echo = FALSE, warning = FALSE}

library(here)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
library(data.table)
library(brms)
library(posterior)
library(colorspace)
library(knitr)
library(mfutils)
library(ggsegSchaefer)
library(purrr)
library(furrr)

source(here("code", "_funs.R"))
source(here("code", "_constants.R"))
source(here("code", "inferential", "_plotting.R"))

## plot settings

opts_chunk$set(out.width = "100%")
theme_set(theme_minimal(base_size = 7))
theme_update(
  strip.background = element_rect(fill = "transparent", color = "transparent")
  )
axis_text_x_angle <- 30
point_size <- 3/2
point_size_small <- 2

# ## other constants, paths, etc...

if (exists('params')) {
  model <- params$model
  mv <- params$mv
  session <- params$session
} else {
  model <- "no_lscov_symm"
  mv <- "rda"  ## for dev
  session <- "reactive"
}

n_cores <- 20
plan(multicore, workers = n_cores)

responses <- c("uv", mv)
atlas_nm <- "schaefer2018_17_400_fsaverage5"
roi_col <- "parcel"  ## "parcel" or "network"
rois <- mfutils::schaefer2018_17_400_fsaverage5$key[[roi_col]]
nois <- c("ContA", "ContB", "DorsAttnA", "DorsAttnB")

path_out <- file.path("/data/nil-external/ccp/chenr/trr", "out")
model_info <- expand.grid(model_nm = model, response = responses, roi_nm = rois)  ## for reading HBM model res
colors_response <- setNames(diverging_hcl(2, palette = "Blue-Red2"), responses)
colors_nois <- c(
  ContA = "firebrick", ContB = "firebrick", DorsAttnA = "firebrick", 
  DorsAttnB = "firebrick", other = "grey60"
  )
## utilities

read_summarize_hbm <- function(
  model_nm, response, session, base_path, atlas_nm, roi_nm, sum_fun = identity, ...
  ) {
  file_name <- file.path(
      base_path, atlas_nm, roi_nm,
      paste0(get_model_info(model_nm, response, session)$model_prefix, ".rds")
      )
  mod <- readRDS(file_name)
  sum_fun(mod, ...)
}
add_names_and_bind <- function(res, .l) {
  for (i in seq_along(res)) {
    res[[i]] <- cbind(res[[i]], .l[i, ])
  }
  bind_rows(res)
}
future_pmap_bind <- function(.x, .f, ...) add_names_and_bind(future_pmap(.x, .f, ...), .x)

get_network <- function(x) gsub("17Networks_.H_([[:alpha:]]*)_.*", "\\1", x)

## read data for summarystat model, subset relevant rows/cols, get subject-level stats:

d_summarystat <-
  fread(file.path(path_out, "spatial", "projections__stroop__rda__n_resamples100__demean_run__cv_allsess.csv"))
d_summarystat <- d_summarystat %>% rename(ridge = value.ridge, rda = value.rda)
cols_keep <- c("roi", responses, "variable", "trial", "subj", "wave")
d_summarystat <- d_summarystat[test_session == session & roi %in% rois, ..cols_keep] %>% na.omit()
d_summarystat <-
  melt(d_summarystat, id.vars = c("roi", "variable", "trial", "subj", "wave"), variable.name = "response")
s_summarystat_subj <- d_summarystat[, .(value = mean(value)), by = c("variable", "subj", "wave", "roi", "response")]

## read already-summarized data, inc. model comparison stats and diagnostics

misc <-
  readRDS(file.path(path_out, "inferential", atlas_nm, "Schaefer400_stats.rds")) %>%
  bind_rows(.id = "model__response__session") %>%
  separate(model__response__session, c("model", "response", "session"), sep = "__") %>%
  filter(session %in% .env$session, response %in% c("uv", .env$mv), model %in% .env$model) %>%
  arrange(model, region) %>%
  rename(roi_nm = region, model_nm = model)
  #mutate(roi_nm = gsub("17Networks_", "", roi_nm))  ## for plotting

#rois <- gsub("17Networks_", "", rois)  ## for plotting

arsinh <- scales::trans_new("signed_log",
       transform = function(x) asinh(x),
       inverse = function(x) sinh(x)
)

```


# population-level effects (fixed)

## high conflict - low conflict contrast

```{r}

## get summarystat model ests:

s_summarystat_pop <- s_summarystat_subj %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(hilo = hi - lo) %>%
  group_by(subj, roi, response) %>%  ## average over wave
  summarize(hilo = mean(hilo)) %>%
  group_by(roi, response) %>%
  summarize(
    Estimate = mean(hilo),
    Est.Error = sd(hilo) / sqrt(n()),
    CI.Lower = Estimate - Est.Error*1.96,
    CI.Upper = Estimate + Est.Error*1.96
  ) %>%
  rename(roi_nm = roi) %>%
  mutate(model_nm = "summarystat")

## get HBM ests:

model_info_fixef <- model_info
model_info_fixef$hyp[model_info_fixef$model_nm %in% c("no_lscov_symm", "fixed_sigma")] <-
  "(hilo_wave1 + hilo_wave1)/2 = 0"
model_info_fixef$hyp[model_info_fixef$model_nm %in% c("no_lscov", "full")] <-
  "(hi_wave1 + hi_wave2)/2 - (lo_wave1 + lo_wave2)/2 = 0"
s_pop_hbm <- future_pmap_bind(
  model_info_fixef,
  read_summarize_hbm,
  session = session,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x, hyp) {
    hypothesis(x, hyp)$hypothesis[, c("Estimate", "Est.Error", "CI.Lower", "CI.Upper")]
  }
)

## bind:

s_pop <- full_join(s_pop_hbm, s_summarystat_pop)
s_pop <- as.data.table(s_pop) %>% mutate(network = get_network(roi_nm))

```

### scatterplots

```{r}

s_pop %>%
  pivot_wider(id_cols = c("model_nm", "roi_nm", "network"), names_from = response, values_from = Estimate) %>%
  ggplot(aes_string("uv", mv, fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = point_size) +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  labs(title = "coef(hi-lo) per ROI")

s_pop %>%
  pivot_wider(id_cols = c("model_nm", "roi_nm", "network"), names_from = response, values_from = Est.Error) %>%
  ggplot(aes_string("uv", mv, fill = "network")) +
  geom_abline() +
  geom_point(shape = 21, color = "white", size = point_size) +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  labs(title = "se(coef(hi-lo)) per ROI")

s_pop %>%
  mutate(stat = Estimate/Est.Error) %>%
  pivot_wider(id_cols = c("model_nm", "roi_nm", "network"), names_from = response, values_from = stat) %>%
  ggplot(aes_string("uv", mv, fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = point_size) +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  labs(title = "t(coef(hi-lo)) per ROI")

```




# subject-level effects (random)

## test-retest reliability in stroop contrast (hi-lo)


```{r}

## get summarystat model ests:

s_summarystat_subj_trr <- s_summarystat_subj %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(hilo = hi - lo) %>%
  pivot_wider(id_cols = c("subj", "roi", "response"), names_from = wave, values_from = hilo) %>%
  rename(roi_nm = roi) %>%
  mutate(model_nm = "summarystat")

## get HBM ests:

s_hbm_subj <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  session = session,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x) {
    mu <- coef(x, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(x)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
    }
    data.frame(wave1 = colMeans(mu_stroop1), wave2 = colMeans(mu_stroop2), subj = dimnames(mu)[[2]])
  }
)

## bind:

s_subj <- full_join(s_hbm_subj, s_summarystat_subj_trr)
s_subj <- as.data.table(s_subj) %>% mutate(network = get_network(roi_nm))

## get summarystat model ests:

r_summarystat <- s_summarystat_subj_trr %>%
  group_by(roi_nm, model_nm, response) %>%
  summarize(r = cor(wave1, wave2)) %>% 
  mutate(network = get_network(roi_nm))

## get HBM posteriors:

s_hbm_posterior <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  session = session,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(mdl) {
    mu <- ranef(mdl, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(mdl)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
    }
    trr <- rep(0, dim(mu)[1])
    for (ii in seq_along(trr)) trr[ii] <- cor(mu_stroop1[ii, ], mu_stroop2[ii, ])
    data.table(trr = trr, resample = seq_along(trr))
  }
)

s_hbm_posterior <- s_hbm_posterior %>% mutate(network = get_network(roi_nm))



```

### subject-level estimates

```{r, fig.width = 12, fig.height = 6}

## averaged over ROIs:

rois_max_fixef <- s_pop %>%
  filter(model_nm == "no_lscov_symm") %>%
  group_by(response) %>%
  slice_max(Estimate, n = 10) %>%
  pull(roi_nm) %>%
  unique

for (roi in rois_max_fixef) {

  p <- s_subj[roi_nm == roi] %>%
    ggplot(aes(wave1, wave2, shape = model)) +
    geom_abline(size = 0.5) +
    geom_hline(yintercept = 0, size = 0.5) +
    geom_vline(xintercept = 0, size = 0.5) +
    geom_point(aes(shape = model_nm, fill = subj, color = subj), size = 2) +
    stat_ellipse(data = . %>% filter(model_nm == model), type = "norm", alpha = 0.5) +
    stat_ellipse(data = . %>% filter(model_nm == "summarystat"), type = "norm", alpha = 0.5) +
    geom_line(aes(group = subj, color = subj), size = 0.5) +
    theme(legend.position = "none") +
    facet_grid(cols = vars(response)) +
    scale_fill_discrete_qualitative() +
    scale_color_discrete_qualitative() +
    scale_shape_manual(values = setNames(c(21, 4), c(model, "summarystat"))) +
    labs(title = roi)

  print(p)

}

```

### posterior distributions

```{r}

## plot:

s_hbm_posterior %>%
  filter(roi_nm %in% rois[core32]) %>%
  ggplot(aes(trr, color = response)) +
  #geom_rect(xmin = 0.7, xmax = 1, ymin = 0, ymax = Inf, fill = "grey50", color = "grey50", alpha = 0.5) +
  geom_density(size = 1) +
  geom_vline(
    data = r_summarystat %>% filter(roi_nm %in% rois[core32]) %>% .[, c("roi_nm", "r", "model_nm", "response")],
    aes(xintercept = r, color = response), linetype = "dashed"
    ) +
  facet_wrap(vars(roi_nm), labeller = labeller(roi_nm = function(x) gsub("17Networks_", "", x))) +
  scale_color_manual(values = colors_response) +
  theme(legend.position = c(0.75, 0.05)) +
  labs(title = "posterior densities for TRR", caption = "dashed line = summary-stat TRR")


for (network_nm in unique(s_hbm_posterior$network)) {

  p <- s_hbm_posterior[network == network_nm] %>%
    ungroup %>%
    ggplot(aes(trr, color = response, group = roi_nm)) +
    geom_density(size = 1, alpha = 0.01) +
    facet_grid(cols = vars(response), rows = vars(network)) +
    scale_color_manual(values = colors_response) +
    theme(legend.position = c(0.75, 0.05)) +
    labs(title = network_nm)

  print(p)

}

```

### statistics on posterior distributions

```{r}

s_hbm_posterior[, .(trr = max_aposteriori(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = trr) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_hline(yintercept = 0.7) +
  geom_vline(xintercept = 0.7) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme(legend.position = "top") +
  labs(title = "MAP(TRR)")

s_hbm_posterior[, .(trr = mean(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = trr) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_hline(yintercept = 0.7) +
  geom_vline(xintercept = 0.7) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme(legend.position = "top") +
  labs(title = "mean(TRR)")

s_hbm_posterior[, .(trr = median(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = trr) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_hline(yintercept = 0.7) +
  geom_vline(xintercept = 0.7) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme(legend.position = "top") +
  labs(title = "median(TRR)")


s_hbm_posterior[, .(trr = quantile(trr, 0.05)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = trr) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_hline(yintercept = 0.7) +
  geom_vline(xintercept = 0.7) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(-1, 1)) +
  theme(legend.position = "top") +
  labs(title = "quantile(TRR, 0.05)")

s_hbm_posterior[, .(trr = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = trr) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  theme(legend.position = "top") +
  labs(title = "sd(TRR)")

```


## trial/subject level variance ratio (hi-lo contrast)

```{r}


## get HBM posteriors:

s_hbm_subj_ratio <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  session = session,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x) {
    ranefs <- ranef(x, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(x)) {
      stroop1 <- ranefs[, , "hilo_wave1"]
      stroop2 <- ranefs[, , "hilo_wave2"]
      if ("b_sigma_Intercept" %in% variables(x))  {
        hyp <- "exp(sigma_Intercept) = 0"
      } else {
        hyp <- "exp((sigma_mean_wave1 + sigma_mean_wave2) / 2) = 0"
      }
    } else {
      stroop1 <- ranefs[, , "hi_wave1"] - ranefs[, , "lo_wave1"]
      stroop2 <- ranefs[, , "hi_wave2"] - ranefs[, , "lo_wave2"]
      hyp <- "exp((sigma_hi_wave1 + sigma_hi_wave2 + sigma_lo_wave1 + sigma_lo_wave2) / 4) = 0"
    }
    sigma_stroop1 <- sqrt(Var(stroop1, 1))
    sigma_stroop2 <- sqrt(Var(stroop2, 1))
    sigma_stroop <- (sigma_stroop1 + sigma_stroop2)/2
    sigma_resid <- hypothesis(x, hyp)$samples$H1
    ratio <- sigma_resid / sigma_stroop

    data.table(
      sigma_resid = sigma_resid, 
      sigma_stroop = sigma_stroop, 
      ratio = sigma_resid / sigma_stroop,
      resample = seq_along(ratio)
      )

  }
)

s_hbm_subj_ratio <- s_hbm_subj_ratio %>% mutate(network = get_network(roi_nm))

```

### posterior distributions


```{r}

## plot:

s_hbm_subj_ratio %>%
  filter(roi_nm %in% rois[core32]) %>%
  ggplot(aes(ratio, color = response)) +
  geom_density(size = 1) +
  facet_wrap(vars(roi_nm), labeller = labeller(roi_nm = function(x) gsub("17Networks_", "", x))) +
  scale_color_manual(values = colors_response) +
  theme(legend.position = c(0.75, 0.05)) +
  scale_x_continuous(trans = "log", labels = function(x) sprintf("%.2f", x)) +
  labs(title = "posterior densities for log sd(trial)/sd(subj_stroop)")

```

### statistics on posterior distributions


```{r}

s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = ratio) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  scale_x_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  theme(legend.position = "none") +
  labs(title = "MAP(ratio)")

s_hbm_subj_ratio[, .(ratio = mean(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = ratio) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  scale_x_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  theme(legend.position = "none") +
  labs(title = "mean(ratio)")

s_hbm_subj_ratio[, .(ratio = median(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = ratio) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  scale_x_continuous(limits = c(1, 100), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  theme(legend.position = "none") +
  labs(title = "median(ratio)")

s_hbm_subj_ratio[, .(ratio = sd(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  pivot_wider(names_from = response, values_from = ratio) %>%
  mutate(noi = ifelse(network %in% nois, network, "other")) %>%
  ggplot(aes_string("uv", mv, color = "noi", fill = "noi")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_fill_manual(values = colors_nois) +
  scale_color_manual(values = colors_nois) +
  scale_y_continuous(limits = c(0.01, 300), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  scale_x_continuous(limits = c(0.01, 300), trans = "log", labels = function(x) sprintf("%.2f", x)) +
  theme(legend.position = "none") +
  labs(title = "sd(ratio)")

```




## TRR bias: log( E(HLM) / summarystat )

### univariate versus multivariate

```{r}

s_hbm_posterior[, .(trr = max_aposteriori(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  ggplot(aes_string("summarystat", model, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  facet_grid(cols = vars(response)) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(limits = c(-1, 1)) +
  scale_x_continuous(limits = c(-1, 1)) +
  theme(legend.position = "top") +
  labs(title = "TRR bias: MAP(HLM TRR) vs summarystat TRR")


s_hbm_posterior[, .(trr = mean(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  ggplot(aes_string("summarystat", model, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  facet_grid(cols = vars(response)) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(limits = c(-1, 1)) +
  scale_x_continuous(limits = c(-1, 1)) +
  theme(legend.position = "none") +
  labs(title = "TRR bias: mean(HLM TRR) vs summarystat TRR")

s_hbm_posterior[, .(trr = median(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  ggplot(aes_string("summarystat", model, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  facet_grid(cols = vars(response)) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(limits = c(-1, 1)) +
  scale_x_continuous(limits = c(-1, 1)) +
  theme(legend.position = "none") +
  labs(title = "TRR bias: median(HLM TRR) vs summarystat TRR")

s_hbm_posterior[, .(trr = max_aposteriori(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  pivot_wider(id_cols = c("roi_nm", "network"), names_from = response, values_from = trr_bias) %>%
  ggplot(aes_string("uv", mv, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "TRR bias: MAP(HLM TRR) / summarystat TRR")

s_hbm_posterior[, .(trr = mean(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  pivot_wider(id_cols = c("roi_nm", "network"), names_from = response, values_from = trr_bias) %>%
  ggplot(aes_string("uv", mv, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "TRR bias: mean(HLM TRR) / summarystat TRR")

s_hbm_posterior[, .(trr = median(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  pivot_wider(id_cols = c("roi_nm", "network"), names_from = response, values_from = trr_bias) %>%
  ggplot(aes_string("uv", mv, color = "network", fill = "network")) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "TRR bias: median(HLM TRR) / summarystat TRR")

s_hbm_posterior[, .(trr = max_aposteriori(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(trr_bias, color = response, fill = response)) +
  geom_vline(xintercept = 0) +
  geom_histogram(position = "identity", alpha = 0.1, bins = 35) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "top") +
  labs(title = "TRR bias: MAP(HLM TRR) / summarystat TRR")

s_hbm_posterior[, .(trr = mean(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(trr_bias, color = response, fill = response)) +
  geom_vline(xintercept = 0) +
  geom_histogram(position = "identity", alpha = 0.1, bins = 35) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "top") +
  labs(title = "TRR bias: mean(HLM TRR) / summarystat TRR")

s_hbm_posterior[, .(trr = median(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(trr_bias, color = response, fill = response)) +
  geom_vline(xintercept = 0) +
  geom_histogram(position = "identity", alpha = 0.1, bins = 35) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  scale_x_continuous(trans = arsinh) +
  theme(legend.position = "top") +
  labs(title = "TRR bias: median(HLM TRR) / summarystat TRR")


s_hbm_posterior[, .(trr = max_aposteriori(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(summarystat, trr_bias, color = network, fill = network)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "MAP(TRR bias) versus summarystat TRR") +
  facet_grid(cols = vars(response))


s_hbm_posterior[, .(trr = mean(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(summarystat, trr_bias, color = network, fill = network)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "mean(TRR bias) versus summarystat TRR") +
  facet_grid(cols = vars(response))


s_hbm_posterior[, .(trr = median(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(trr = r)) %>%
  pivot_wider(names_from = model_nm, values_from = trr) %>%
  mutate(trr_bias = !!as.symbol(model) / summarystat) %>%
  ggplot(aes(summarystat, trr_bias, color = network, fill = network)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(trans = arsinh) +
  theme(legend.position = "none") +
  labs(title = "median(TRR bias) versus summarystat TRR") +
  facet_grid(cols = vars(response))


```

### vs SD(TRR)

```{r}

s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  ggplot(aes(trr_sd, summarystat, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_hline(yintercept = 0) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  facet_grid(cols = vars(response)) +
  labs(title = "summarystat TRR ~ SD(HBM TRR)")

s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  ggplot(aes(trr_sd, trr_bias, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_hline(yintercept = 0) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  scale_y_continuous(trans = arsinh) +
  facet_grid(cols = vars(response)) +
  labs(title = "MAP(TRR) bias ~ SD(HBM TRR)")

s_hbm_posterior[, .(trr = mean(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  ggplot(aes(trr_sd, trr_bias, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_hline(yintercept = 0) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  scale_y_continuous(trans = arsinh) +
  facet_grid(cols = vars(response)) +
  labs(title = "mean(TRR) bias ~ SD(HBM TRR)")

```

## vs variability ratio

```{r}

s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  full_join(s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  ggplot(aes(summarystat, log(ratio), color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_vline(xintercept = 1) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  facet_grid(cols = vars(response)) +
  scale_y_continuous(trans = arsinh) +
  labs(title = "summarystat TRR ~ log MAP(ratio)")


s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  full_join(s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  ggplot(aes(trr_bias, log(ratio), color = network, fill = network)) +
  geom_vline(xintercept = 1) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  facet_grid(cols = vars(response)) +
  theme(legend.position = "top") +
  scale_x_continuous(trans = arsinh) +
  labs(title = "MAP(TRR) bias ~ log MAP(ratio)")

s_hbm_posterior[, .(trr = mean(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  full_join(s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  ggplot(aes(trr_bias, log(ratio), color = network, fill = network)) +
  geom_vline(xintercept = 1) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  facet_grid(cols = vars(response)) +
  theme(legend.position = "top") +
  scale_x_continuous(trans = arsinh) +
  labs(title = "mean(TRR) bias ~ log MAP(ratio)")

s_hbm_posterior[, .(trr = median(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  mutate(trr_bias = trr / summarystat) %>%
  full_join(s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  ggplot(aes(trr_bias, log(ratio), color = network, fill = network)) +
  geom_vline(xintercept = 1) +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  facet_grid(cols = vars(response)) +
  theme(legend.position = "top") +
  scale_x_continuous(trans = arsinh) +
  labs(title = "median(TRR) bias ~ log MAP(ratio)")

```

## recovered ICC vs measured ICC

```{r}

m <- n_trialspr[paste0("Stroop_", session)]  ## approx number trials per condition
s_hbm_subj_ratio[, .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  mutate(R_u = 1 / (1 + 2/m*ratio^2)) %>%
  full_join(s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  mutate(summarystat_pred = R_u*trr) %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  ggplot(aes(summarystat, summarystat_pred, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_abline() +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  facet_grid(cols = vars(response)) +
  labs(title = "measured summarystat TRR ~ predicted summarystat TRR")

s_hbm_subj_ratio[, .(ratio = mean(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  mutate(R_u = 1 / (1 + 2/m*ratio^2)) %>%
  full_join(s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  mutate(summarystat_pred = R_u*trr) %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  ggplot(aes(summarystat, summarystat_pred, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_abline() +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  facet_grid(cols = vars(response)) +
  labs(title = "measured summarystat TRR ~ predicted summarystat TRR from mean(HBM TRR)")

s_hbm_subj_ratio[, .(ratio = median(ratio)), by = c("model_nm", "roi_nm", "response", "network")] %>%
  mutate(R_u = 1 / (1 + 2/m*ratio^2)) %>%
  full_join(s_hbm_posterior[, .(trr = max_aposteriori(trr), trr_sd = sd(trr)), by = c("model_nm", "roi_nm", "response", "network")]) %>%
  mutate(summarystat_pred = R_u*trr) %>%
  full_join(r_summarystat %>% rename(summarystat = r) %>% ungroup %>% select(-model_nm)) %>%
  ggplot(aes(summarystat, summarystat_pred, color = network, fill = network)) +
  geom_point(shape = 21, size = point_size) +
  geom_abline() +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  theme(legend.position = "top") +
  facet_grid(cols = vars(response)) +
  labs(title = "measured summarystat TRR ~ predicted summarystat TRR from median(HBM TRR)")


```

# model comparison, diagnostics

```{r eval = FALSE}

misc %>%
  filter(Term == "Bayes_R2") %>%
  pivot_wider(id_cols = c("roi_nm"), names_from = response, values_from = Estimate) %>%
  ggplot(aes_string("uv", mv, color = "roi_nm", fill = "roi_nm")) +
  geom_abline() +
  geom_point(shape = 21, size = point_size) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  scale_y_continuous(limits = c(0, 0.05)) +
  scale_x_continuous(limits = c(0, 0.05)) +
  theme(legend.position = "none") +
  labs(title = "Bayes R2")

```


```{r}

diagnostics <-
  future_pmap_bind(
    model_info,
    read_summarize_hbm,
    session = session,
    base_path = file.path(path_out, "inferential"),
    atlas_nm = atlas_nm,
    sum_fun = function(x) {
      xsum <- summary(x)
      random <- xsum$random$subj[, c("Rhat", "Bulk_ESS", "Tail_ESS")]
      fixed <- xsum$fixed[, c("Rhat", "Bulk_ESS", "Tail_ESS")]
      random <- cbind(term = rownames(random), class = "random", random)
      fixed <- cbind(term = rownames(fixed), class = "fixed", fixed)
      rbind(fixed, random)
    }
)

```

## Rhats

```{r}

diagnostics %>%
  filter(class == "fixed") %>%
  mutate(network = get_network(roi_nm)) %>%
  pivot_wider(id_cols = c("roi_nm", "term", "network"), names_from = "response", values_from = "Rhat") %>%
  ggplot(aes_string("uv", mv)) +
  geom_hline(yintercept = 1.01) +
  geom_vline(xintercept = 1.01) +
  geom_point(aes(color = network), position = position_jitter(width = 0.01, height = 0.01)) +
  facet_wrap(vars(term)) +
  scale_color_viridis_d() +
  labs(title = "fixed effects") +
  theme(legend.position = "top")

diagnostics %>%
  filter(class == "random") %>%
  mutate(network = get_network(roi_nm)) %>%
  pivot_wider(id_cols = c("roi_nm", "term", "network"), names_from = "response", values_from = "Rhat") %>%
  ggplot(aes_string("uv", mv)) +
  geom_hline(yintercept = 1.01) +
  geom_vline(xintercept = 1.01) +
  geom_point(aes(color = network), position = position_jitter(width = 0.01, height = 0.01)) +
  facet_wrap(vars(term)) +
  scale_color_viridis_d() +
  labs(title = "random effects") +
  theme(legend.position = "top")

```


<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
