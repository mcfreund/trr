
---
title: "Generate figures for manuscript"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_depth: 3 
        toc_float: true
        number_sections: true
        df_print: paged
        code_folding: hide
---


```{r setup, results = FALSE, message = FALSE, echo = FALSE, warning = FALSE}


library(here)
library(ggplot2)
library(reshape2)
library(dplyr)
library(tidyr)
library(data.table)
library(brms)
library(posterior)
library(colorspace)
library(knitr)
library(mfutils)
library(ggsegSchaefer)
library(purrr)
library(furrr)
library(patchwork)

source(here("code", "_funs.R"))
source(here("code", "_constants.R"))
source(here("code", "inferential", "_plotting.R"))

## plot settings

opts_chunk$set(out.width = "100%")
theme_set(theme_minimal(base_size = 12))
theme_update(
  strip.background = element_rect(fill = "transparent", color = "transparent"),
  axis.line.y.left = element_line(),
  axis.line.x.bottom = element_line(),
  axis.ticks = element_line(),
  panel.grid = element_blank()
  )
axis_text_x_angle <- 30

legend_network8 <- data.frame(
  network = c("Cont", "Default", "DorsAttn", "SalVentAttn", "SomMot", "Temp", "Vis", "Limbic"),
  color = c(qualitative_hcl(7, palette = "Dark 3"), "grey50"),
  label = c(
    "Cont", "\nDefault", "\n\nDorsAttn", "\n\n\nSalVentAttn", "\n\n\n\nSomMot", "\n\n\n\n\nTemp", "\n\n\n\n\n\nVis",
    "\n\n\n\n\n\n\nLimbic"
    ),
    stringsAsFactors = FALSE
)
colors_network8 <- setNames(legend_network8$color, legend_network8$network)
colors_response <- setNames(diverging_hcl(10, palette = "Purple-Brown")[c(2, 9)], c("rda", "uv"))
colors_models <- c(summarystat = "grey40", no_lscov_symm = "firebrick")
colors_nois <- c(
  ContA = "firebrick", ContB = "firebrick", DorsAttnA = "firebrick",
  DorsAttnB = "firebrick", other = "grey60"
  )
example_rois <- c(
    "17Networks_LH_ContA_PFCl_2",
    "17Networks_LH_ContA_IPS_4"
  )
example_roi_names <- c(
  `17Networks_LH_ContA_PFCl_2` = "left PFCl_2",
  `17Networks_LH_ContA_IPS_4` = "left IPS_4"
  )

## other constants, paths, etc...

n_cores <- 30
plan(multicore, workers = n_cores)

responses <- c("rda", "uv")
models <- c("full", "no_lscov", "no_lscov_symm", "fixed_sigma", "summarystat")
models_hbm <- c("full", "no_lscov", "no_lscov_symm", "fixed_sigma")
atlas_nm <- "schaefer2018_17_400_fsaverage5"
roi_col <- "parcel"  ## "parcel" or "network"
rois <- mfutils::schaefer2018_17_400_fsaverage5$key[[roi_col]]

path_out <- file.path("/data/nil-external/ccp/chenr/trr", "out")
model_info <- expand.grid(model_nm = "no_lscov_symm", response = responses, roi_nm = rois, session = sessions)

## utilities

## read data for summarystat model, subset relevant rows/cols, get subject-level stats:

d_summarystat <-
  fread(file.path(path_out, "spatial", "projections__stroop__rda__n_resamples100__demean_run__cv_allsess.csv")) %>%
  rename(ridge = value.ridge, rda = value.rda, session = test_session)
cols_keep <- c("roi", "uv", "rda", "variable", "trial", "subj", "wave", "session")
d_summarystat <- na.omit(d_summarystat[, ..cols_keep])
s_summarystat_subj <- d_summarystat[,
  lapply(.SD, mean),
  by = c("variable", "subj", "wave", "roi", "session"),
  .SDcols = responses
  ]

## read already-summarized data, inc. model comparison stats and diagnostics

misc <-
  readRDS(file.path(path_out, "inferential", atlas_nm, "core32_stats.rds")) %>%
  bind_rows(.id = "model__response__session") %>%
  separate(model__response__session, c("model", "response", "session"), sep = "__") %>%
  filter(session == "baseline") %>%
  mutate(model = factor(model, .env$models, ordered = T)) %>%
  arrange(model, region) %>%
  rename(roi_nm = region, model_nm = model)

```

# model comparison

```{r}

p_elpd <-
  misc %>%
  filter(Term == "elpd_loo") %>%
  pivot_wider(id_cols = c("response", "roi_nm"), names_from = "model_nm", values_from = "Estimate") %>%
  mutate(
    full__no_lscov = full - no_lscov,
    full__no_lscov_symm = full - no_lscov_symm,
    full__fixed_sigma = full - fixed_sigma
  ) %>%
  pivot_longer(c("full__no_lscov", "full__no_lscov_symm", "full__fixed_sigma")) %>%
  mutate(
    name = gsub("full__", "", name),
    name = factor(name, levels = rev(c("no_lscov", "no_lscov_symm", "fixed_sigma")))
  ) %>%
  ggplot(aes(name, value)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(aes(group = roi_nm), alpha = 0.5) +
  facet_grid(cols = vars(response), labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))) +
  scale_y_continuous(trans = arsinh, breaks = c(-4, 0, 4, 100, 1000)) +
  labs(x = "simplified model", y = "ELPD diff. vs. full model") +
  theme(axis.line.x.bottom = element_line(), axis.line.y.left = element_blank()) +
  coord_flip()

p_elpd

dir.create(here("figs", "model_comparison"), showWarnings = FALSE)
ggsave(here("figs", "model_comparison", "elpd.pdf"), p_elpd, dev = "pdf", width = 5, height = 3)

```

# fixed effects

```{r}

## get summarystat model ests:

s_summarystat_pop <- s_summarystat_subj %>%
  pivot_longer(cols = all_of(responses), names_to = "response") %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(hilo = hi - lo) %>%
  # group_by(subj, roi, session, response, wave) %>%
  # summarize(hilo = mean(hilo)) %>%
  group_by(roi, session, response, wave) %>% ## average over subjects
  summarize(
    Estimate = mean(hilo),
    Est.Error = sd(hilo) / sqrt(n()),
    CI.Lower = Estimate - Est.Error * qnorm(0.975),
    CI.Upper = Estimate + Est.Error * qnorm(0.975)
  ) %>%
  rename(roi_nm = roi) %>%
  mutate(model_nm = "summarystat")

## get HBM ests:

model_info_fixef <- expand.grid(
  model_nm = "no_lscov_symm", response = responses, roi_nm = rois, session = sessions,
  hyp = c("hilo_wave1 = 0", "hilo_wave2 = 0"),
  stringsAsFactors = FALSE
  )
s_pop_hbm <- future_pmap_bind(
  model_info_fixef,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x, hyp) {
    hypothesis(x, hyp)$hypothesis[, c("Estimate", "Est.Error", "CI.Lower", "CI.Upper")]
  }
)
s_pop_hbm <- s_pop_hbm %>% mutate(wave = gsub("hilo_(.*) = 0", "\\1", hyp))

## bind summary stat and hbm:
s_pop <- full_join(s_pop_hbm, s_summarystat_pop) %>% as.data.table %>% mutate(network = get_network(roi_nm))

```

## baseline+reactive sessions

```{r}

p_pop_scatter_wave <- s_pop %>%
  filter(session %in% c("baseline", "reactive"), model_nm == "summarystat", response == "uv") %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "model_nm", "response", "session"), names_from = c("wave"), values_from = "Estimate"
  ) %>%
  ggplot(aes(wave1, wave2)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_point(aes(fill = get_network(network, TRUE)), size = 1, shape = 21, color = "white") +
  facet_grid(cols = vars(session)) +
  scale_fill_manual(values = colors_network8) +
  theme(legend.position = "none") +
  geom_text(
    data = legend_network8 %>% mutate(session = "baseline"),
    aes(label = label, color = color, x = -0.125, y = 0.15), hjust = 0, fontface = "bold", size = 3) +
  labs(x = "mean(stroop rep. 1)", y = "mean(stroop rep. 2)")

p_pop_scatter_ses <- s_pop %>%
  filter(session %in% c("baseline", "reactive"), model_nm == "summarystat", response == "uv") %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "model_nm", "response", "wave"), names_from = c("session"), values_from = "Estimate"
  ) %>%
  ggplot(aes(baseline, reactive)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_point(aes(fill = get_network(network, TRUE)), size = 1, shape = 21, color = "white") +
  facet_grid(cols = vars(wave), labeller = labeller(wave = c(wave1 = "repetition 1", wave2 = "repetition 2"))) +
  scale_fill_manual(values = colors_network8) +
  theme(legend.position = "none") +
  labs(x = "mean(stroop bas.)", y = "mean(stroop rea.)")

p_pop_scatter <- p_pop_scatter_wave / p_pop_scatter_ses
p_pop_scatter
ggsave(here("figs", "_for_ms", "population_stability.pdf"), width = 6, height = 6, dev = "pdf")

## maps

p_pop_brains <- s_pop %>%
  filter(model_nm == "summarystat", session %in% c("baseline", "reactive"), response == "uv") %>%
  as.data.frame %>%
  rename(region = "roi_nm") %>%
  mutate(t = Estimate / Est.Error, sig = ifelse(0 == sign(CI.Lower) + sign(CI.Upper), "ns", "sig")) %>%
  group_by(session, response, wave) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = t, alpha = sig), atlas = atlas, position = position_brain(. ~ hemi + side)) +
  scale_fill_viridis_c(
      option = "magma", na.value = "white",
      limits = c(-8.5, 8.5)
      ) +
  scale_alpha_manual(values = c(sig = 1, ns = 1), guide = "none") +
  theme_surface +
  facet_grid(
    vars(session, wave),
    labeller = labeller(wave = c(wave1 = "repetiton 1", wave2 = "repetition 2")),
    switch = "y") +
  theme(
    axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank()
    )

p_pop_hist <- s_pop %>%
  filter(model_nm == "summarystat", session %in% c("baseline", "reactive"), response == "uv") %>%
  as.data.frame %>%
  rename(region = "roi_nm") %>%
  mutate(t = Estimate / Est.Error, sig = ifelse(0 == sign(CI.Lower) + sign(CI.Upper), "ns", "sig")) %>%
  ggplot(aes(x = t)) +
  geom_vline(xintercept = 0) +
  geom_histogram(fill = "grey30", color = "black", bins = 35) +
  facet_grid(
    vars(session, wave),
    labeller = labeller(wave = c(wave1 = "repetiton 1", wave2 = "repetition 2"))
    ) +
  labs(y = "number of regions", x = "tstat(stroop contrast)") +
  theme(strip.text = element_blank())

p_pop_brains_hist <- p_pop_brains + p_pop_hist + plot_layout(widths = c(2, 1), heights = 1)
p_pop_brains_hist
ggsave(here("figs", "_for_ms", "population_brains.pdf"), width = 8, height = 4, dev = "pdf")

p_pop <- p_pop_brains + p_pop_hist + p_pop_scatter + plot_layout(widths = c(5/3, 1, 1.5), heights = 1)
ggsave(here("figs", "_for_ms", "population.pdf"), width = 12, height = 4, dev = "pdf")

```

## all sessions

```{r}

levs <- c("b1", "p1", "r1", "b2", "p2", "r2")

p_pop_supp_brains <-
  s_pop %>%
  filter(model_nm == "summarystat") %>%
  mutate(
    session_wave = gsub("aseline|roactive|eactive|wave", "", paste0(session, wave))
  ) %>%
  as.data.frame %>%
  rename(region = "roi_nm") %>%
  mutate(t = Estimate / Est.Error, sig = ifelse(0 == sign(CI.Lower) + sign(CI.Upper), "ns", "sig")) %>%
  group_by(session_wave, response) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = t, alpha = sig), atlas = atlas, position = position_brain(. ~ hemi + side)) +
  scale_fill_viridis_c(
      option = "magma", na.value = "white",
      limits = c(-8.5, 8.5)
      ) +
  scale_alpha_manual(values = c(sig = 1, ns = 1), guide = "none") +
  theme_surface +
  facet_grid(
    vars(session_wave),
    vars(response),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate")),
    switch = "y") +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank())

p_pop_supp_cormat <-
  s_pop %>%
  filter(model_nm == "summarystat") %>%
  mutate(
    session_wave = gsub("aseline|roactive|eactive|wave", "", paste0(session, wave))
  ) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "model_nm", "response"),
    names_from = "session_wave",
    values_from = "Estimate"
    ) %>%
  split(.$response) %>%
  map(~ melt_mat(cor(select(., where(is.numeric))))) %>%
  bind_rows(.id = "response") %>%
  mutate(
    Var1 = factor(Var1, levels = rev(levs)),
    Var2 = factor(Var2, levels = levs)
    ) %>%
  plot_melted_mat +
  scale_fill_viridis_c(option = "magma") +
  geom_text(aes(label = round(value, 2)), color = "grey50", size = 3) +
  facet_grid(
    cols = vars(response),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))
    ) +
  theme_minimal() +
  theme(
    axis.title = element_blank(), legend.title = element_blank(), axis.ticks = element_line(), 
    panel.grid = element_blank(),
    legend.position = "none"
    )

p_pop_supp_all <- p_pop_supp_brains + p_pop_supp_cormat + plot_layout(widths = c(1, 1), heights = 1)
p_pop_supp_all
ggsave(here("figs", "_for_ms", "population_supp_all.pdf"), width = 12, height = 4, dev = "pdf")

p_pop_supp_model <-
  s_pop %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "response", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
  ) %>%
  ggplot(aes(summarystat, no_lscov_symm)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_point(aes(fill = get_network(network, TRUE), color = get_network(network, TRUE)), size = 1, shape = 21) +
  facet_grid(cols = vars(session), rows = vars(wave)) +
  scale_fill_manual(values = colors_network8) +
  scale_color_manual(values = colors_network8) +
  theme(legend.position = "none") +
  geom_text(
    data = legend_network8 %>% mutate(session = "baseline", wave = "wave1"),
    aes(label = label, color = network, x = -0.2, y = 0.5), hjust = 0, fontface = "bold", size = 2) +
  labs(x = "summ. stat. mean(stroop)", y = "HBM mean(stroop)")

p_pop_supp_model
ggsave(here("figs", "_for_ms", "population_supp_model.pdf"), width = 3*3/2, height = 3, dev = "pdf")

```

# TRR

```{r}

## get summarystat model ests:

s_summarystat_subj_trr <- s_summarystat_subj %>%
  pivot_longer(cols = all_of(responses), names_to = "response") %>%
  pivot_wider(names_from = variable, values_from = value) %>%
  mutate(hilo = hi - lo) %>%
  pivot_wider(id_cols = c("subj", "roi", "response", "session"), names_from = wave, values_from = hilo) %>%
  rename(roi_nm = roi) %>%
  mutate(model_nm = "summarystat")

## get HBM ests:

s_hbm_subj <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x) {
    mu <- coef(x, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(x)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
    }
    data.frame(wave1 = colMeans(mu_stroop1), wave2 = colMeans(mu_stroop2), subj = dimnames(mu)[[2]])
  }
)

## bind:

s_subj <- full_join(s_hbm_subj, s_summarystat_subj_trr)
s_subj <- as.data.table(s_subj) %>% mutate(network = get_network(roi_nm), network = get_network(roi_nm, TRUE))

## get summarystat model ests:

r_summarystat <- s_summarystat_subj_trr %>%
  group_by(roi_nm, model_nm, response, session) %>%
  summarize(r = cor(wave1, wave2)) %>%
  mutate(network = get_network(roi_nm))

## get HBM posteriors:

s_hbm_posterior <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(mdl) {
    mu <- ranef(mdl, summary = FALSE)$subj  ## for conditional TRR
    S <- VarCorr(mdl, summary = FALSE)$subj  ## for marginal TRR
    if ("sd_subj__hilo_wave1" %in% variables(mdl)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
      trr <- S$cor[, "hilo_wave1", "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
      trr <- NA  ## marginal ranefs not yet implemented for this parameterization
    }
    trr_conditional <- rep(0, dim(mu)[1])
    for (ii in seq_along(trr_conditional)) trr_conditional[ii] <- cor(mu_stroop1[ii, ], mu_stroop2[ii, ])
    stopifnot(length(trr_conditional) == length(trr))
    data.table(trr = trr, trr_conditional = trr_conditional, resample = seq_along(trr))
  }
)

s_hbm_posterior[, network := get_network(roi_nm, TRUE)]

```


## TRR: summary stat

### baseline+reactive

```{r}

df <- length(unique(d_summarystat$subj)) - 1
s_summarystat_pop_r <- s_summarystat_pop %>%
  group_by(roi_nm, session, response) %>%
  summarize(
    tstat = mean(Estimate/Est.Error),
    r = sqrt(tstat^2 / (tstat^2 + df)) * sign(tstat),
  ) %>%
  mutate(
    level = "population",
    model_nm = "summarystat",
    network = get_network(roi_nm)
  )

for (response_nm in c("uv", "rda")) {

  p_trr_sumstat_brains <-
      r_summarystat %>%
      filter(response == response_nm, session %in% c("baseline", "reactive")) %>%
      as.data.frame %>%
      rename(region = "roi_nm") %>%
      group_by(session, response) %>%
      ggplot() +
      geom_brain(mapping = aes(fill = r), atlas = atlas, position = position_brain(. ~ hemi + side)) +
      scale_fill_viridis_c(option = "magma", na.value = "white", limits = c(-0.8, 1)) +
      theme_surface +
      facet_grid(vars(session), switch = "y") +
      theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.25)) +
      labs(fill = "TRR")

  p_trr_sumstat_hist <- 
    r_summarystat %>%
    filter(response == response_nm, session %in% c("baseline", "reactive")) %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    ggplot(aes(x = r)) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_histogram(fill = "grey30", color = "black", bins = 35) +
    facet_grid(vars(session)) +
    labs(y = "number of regions", x = "Stroop TRR (r)") +
    theme(strip.text = element_blank()) +
    coord_cartesian(xlim = c(-1, 1))
  p_trr_sumstat_uv_hist

  p_trr_scatter_ses <-
    r_summarystat %>% 
    mutate(level = "subject") %>%
    full_join(s_summarystat_pop_r) %>%
    filter(session %in% c("baseline", "reactive"), response == response_nm) %>%
    pivot_wider(
      id_cols = c("roi_nm", "model_nm", "response", "session", "network"),
      names_from = "level",
      values_from = "r"
    ) %>%
    ggplot(aes(population, subject)) +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_point(aes(fill = get_network(network, TRUE)), size = 1, shape = 21, color = "white") +
    geom_text(
      data = legend_network8 %>% mutate(session = "baseline"),
      aes(label = label, color = network, x = -0.6, y = -0.2), hjust = 0, fontface = "bold", size = 1.5) +
    scale_fill_manual(values = colors_network8) +
    theme(legend.position = "none") +
    labs(y = "Stroop TRR (r)", x = "Stroop pop. effect (r)") +
    facet_grid(cols = vars(session)) +
    scale_y_continuous(limits = c(-0.8, 1)) +
    scale_x_continuous(limits = c(-0.8, 1))

  p_trr_sumstat <-
    p_trr_sumstat_brains + p_trr_sumstat_hist + p_trr_scatter_ses + 
    plot_layout(widths = c(5/3, 1, 1.5), heights = 1)
  plot(p_trr_sumstat)
  ggsave(here("figs", "_for_ms", paste0("subject_sumstat_", response_nm, ".pdf")), width = 8, height = 2.2, dev = "pdf")

}

```

### all sessions

```{r}

for (response_nm in c("uv", "rda")) {

  p_trr_sumstat_brains <-
      r_summarystat %>%
      filter(response == response_nm) %>%
      as.data.frame %>%
      rename(region = "roi_nm") %>%
      group_by(session, response) %>%
      ggplot() +
      geom_brain(mapping = aes(fill = r), atlas = atlas, position = position_brain(. ~ hemi + side)) +
      scale_fill_viridis_c(option = "magma", na.value = "white", limits = c(-0.8, 1)) +
      theme_surface +
      facet_grid(vars(session), switch = "y") +
      theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, -0.25)) +
      labs(fill = "TRR")

  p_trr_sumstat_hist <- 
    r_summarystat %>%
    filter(response == response_nm) %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    ggplot(aes(x = r)) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_histogram(fill = "grey30", color = "black", bins = 35) +
    facet_grid(vars(session)) +
    labs(y = "number of regions", x = "Stroop TRR (r)") +
    theme(strip.text = element_blank()) +
    coord_cartesian(xlim = c(-1, 1))
  p_trr_sumstat_uv_hist

  p_trr_scatter_ses <-
    r_summarystat %>% 
    mutate(level = "subject") %>%
    full_join(s_summarystat_pop_r) %>%
    filter(response == response_nm) %>%
    pivot_wider(
      id_cols = c("roi_nm", "model_nm", "response", "session", "network"),
      names_from = "level",
      values_from = "r"
    ) %>%
    ggplot(aes(population, subject)) +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_point(aes(fill = get_network(network, TRUE)), size = 1, shape = 21, color = "white") +
    geom_text(
      data = legend_network8 %>% mutate(session = "baseline"),
      aes(label = label, color = network, x = -0.6, y = -0.2), hjust = 0, fontface = "bold", size = 1.5) +
    scale_fill_manual(values = colors_network8) +
    theme(legend.position = "none") +
    labs(y = "Stroop TRR (r)", x = "Stroop pop. effect (r)") +
    facet_grid(cols = vars(session)) +
    scale_y_continuous(limits = c(-0.8, 1)) +
    scale_x_continuous(limits = c(-0.8, 1))

  p_trr_sumstat <-
    p_trr_sumstat_brains + p_trr_sumstat_hist + p_trr_scatter_ses + 
    plot_layout(widths = c(5/3, 1, 1.5), heights = 1)
  plot(p_trr_sumstat)
  ggsave(here("figs", "_for_ms", paste0("subject_sumstat_", response_nm, "_allsession.pdf")), width = 8, height = 3, dev = "pdf")

}

```

## TRR: HBM posteriors

### networks
  
```{r}

p_trrpost_conta <-
  s_hbm_posterior[roi_nm %in% rois[get_network(rois) == "ContA"] & session %in% c("baseline", "reactive")] %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_density(size = 1, aes(fill = NULL, group = roi_nm)) +
  geom_vline(
    data = r_summarystat %>% filter(roi_nm %in% example_rois) %>% .[, c("roi_nm", "r", "model_nm", "response")],
    aes(xintercept = r, color = response),
    linetype = "dotted"
    ) +
  facet_grid(
    rows = vars(response),
    cols = vars(session),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))
  ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability", y = "density")
p_trrpost_conta
ggsave(here("figs", "_for_ms", "subject_hbm_trr.pdf"), width = 4, height = 4, dev = "pdf")


s_hbm_posterior[roi_nm %in% rois[get_network(rois) == "ContA"][1] & session %in% c("baseline")] %>%
  group_by(response) %>%
  reframe(dens = density(trr)$y, x = density(trr)$x) %>%
  pivot_wider(id_cols = c("x"), names_from = "response", values_from = "dens") %>%

#s_pop %>% filter(network == "ContA", CI.Lower > 0, CI.Upper > 0, model_nm == "summarystat", response == "uv", session == "baseline", wave == "wave1") %>% pull(roi_nm)
#p_trrpost_conta <-
  s_hbm_posterior[roi_nm %in% rois[get_network(rois) == "ContA"] & session %in% c("baseline", "reactive")] %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_density(
    aes(alpha = s_pop %>% filter(network == "ContA") %>% mutate(CI.Lower > 0))
    size = 1, aes(fill = NULL, group = roi_nm)
    ) +
  geom_vline(
    data = r_summarystat %>% filter(roi_nm %in% example_rois) %>% .[, c("roi_nm", "r", "model_nm", "response")],
    aes(xintercept = r, color = response),
    linetype = "dotted"
    ) +
  facet_grid(
    rows = vars(response),
    cols = vars(session),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))
  ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability", y = "density")



```

## TRR: statistics on posteriors


```{r}

s_hbm_posterior_sum <-
  s_hbm_posterior[,
  .(
    trr_map = max_aposteriori(trr),
    trr_mean = mean(trr),
    trr_05 = quantile(trr, 0.05),
    trr_sd = sd(trr)
  ),
  by = c("model_nm", "roi_nm", "response", "network", "session")
  ]
s_hbm_posterior_sum <- melt(
  s_hbm_posterior_sum,
  id.vars = c("model_nm", "roi_nm", "response", "network", "session")
  )
s_hbm_posterior_sum$network <- get_network(s_hbm_posterior_sum$roi_nm, get_8 = TRUE)
s_hbm_posterior_sum_w <- s_hbm_posterior_sum %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "network", "session", "model_nm", "variable"),
    names_from = "response", values_from = "value"
    )

p_trr_sum <- list()
for (session_val in sessions) {

  p_trr_sum[[paste0("scatter_", session_val)]] <-
    s_hbm_posterior_sum_w %>%
    filter(variable %in% c("trr_map", "trr_mean", "trr_05"), session == session_val) %>%
    ggplot(aes(uv, rda, fill = network)) +
    geom_abline(linetype = "dotted") +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 1.5) +
    facet_grid(cols = vars(variable), labeller = labeller(variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile"))) +
    scale_fill_discrete_qualitative(palette = "Dark 3") +
    scale_color_discrete_qualitative(palette = "Dark 3") +
    scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
    theme(legend.position = "none") +
    labs(x = "univariate TRR", y = "multivariate TRR")

  p_trr_sum[[paste0("scatter_thresh_network3_", session_val)]] <-
    s_hbm_posterior_sum_w %>%
    filter(variable %in% c("trr_map", "trr_mean", "trr_05"), session == session_val) %>%
    ggplot(aes(uv, rda, fill = network)) +
    geom_abline(linetype = "dotted") +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_point(aes(shape = roi_nm %in% example_rois, alpha = network %in% c("Cont", "DorsAttn", "SalVentAttn")), color = "white", size = 1.5) +
    facet_grid(cols = vars(variable), labeller = labeller(variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile"))) +
    scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = 0.1)) +
    scale_fill_discrete_qualitative(palette = "Dark 3") +
    scale_color_discrete_qualitative(palette = "Dark 3") +
    scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
    theme(legend.position = "none") +
    labs(x = "univariate TRR", y = "multivariate TRR")

  p_trr_sum[[paste0("brain_", session_val)]] <-
    s_hbm_posterior_sum %>%
    filter(session == session_val, variable %in% c("trr_map", "trr_mean", "trr_05")) %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    group_by(variable, response) %>%
    ggplot() +
    geom_brain(mapping = aes(fill = value), atlas = atlas, position = position_brain(. ~ hemi + side)) +
    scale_fill_viridis_c(
        option = "magma", na.value = "white",
        limits = c(0, 1), breaks = c(0, 0.5, 1)
        ) +
    theme_surface +
    facet_grid(
      vars(variable), vars(response),
      labeller = labeller(
        response = c(uv = "univariate", rda = "multivariate"),
        variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile")
        )) +
    theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/3)) +
    labs(fill = "TRR")

  dir.create(here("figs", "trr"), showWarnings = FALSE)
  ggsave(
    here("figs", "trr", paste0("scatter_", session_val, ".pdf")),
    p_trr_sum[[paste0("scatter_", session_val)]],
    dev = "pdf", width = 8, height = 8/3
    )
  ggsave(
    here("figs", "trr", paste0("scatter_thresh_network3_", session_val, ".pdf")),
    p_trr_sum[[paste0("scatter_thresh_network3_", session_val)]],
    dev = "pdf", width = 8, height = 8/3
    )
  ggsave(
    here("figs", "trr", paste0("brain_", session_val, ".pdf")),
    p_trr_sum[[paste0("brain_", session_val)]],
    dev = "pdf", width = 8, height = 3
    )

}


#r_summarystat %>% filter(roi_nm %in% example_rois) %>% .[, c("roi_nm", "r", "model_nm", "response")],

full_join(
  s_hbm_posterior_sum %>%
      filter(session == "baseline", variable %in% c("trr_map"), response == "uv") %>%
      ungroup %>%
      select(roi_nm, model_nm, value),
  r_summarystat %>% 
    filter(session == "baseline", response == "uv") %>%
    rename(value = r) %>%
    ungroup %>%
    select(roi_nm, model_nm, value)
    ) %>%
    rename(region = roi_nm) %>%
    group_by(model_nm) %>%
    ggplot() +
    geom_brain(mapping = aes(fill = value), atlas = atlas, position = position_brain(. ~ hemi + side)) +
    scale_fill_viridis_c(
        option = "magma", na.value = "white",
        limits = c(0, 1), breaks = c(0, 0.5, 1)
        ) +
    theme_surface +
    facet_grid(
      vars(model_nm),
      labeller = labeller(
        model_nm = c(no_lscov_symm = "HBM MAP", summarystat = "ICC"),
        )) +
    theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/2)) +
    labs(fill = "TRR")
  ggsave(
    here("figs", "trr", "brain_baseline_univariate.pdf"),
    dev = "pdf", width = 8, height = 2
    )


```








## example ROIs

```{r}

s_hbm_posterior_sum_w %>% filter(session == "baseline", variable == "trr_05") %>% arrange(-rda)
s_hbm_posterior_sum_w %>% filter(session == "baseline", variable == "trr_05") %>% arrange(-uv)
s_hbm_posterior_sum_w %>% filter(session == "baseline", variable == "trr_05") %>% arrange(-(rda+uv))
s_hbm_posterior_sum_w %>% filter(session == "baseline", variable == "trr_sd", grepl("PFC", roi_nm)) %>% arrange((rda))
s_hbm_posterior_sum_w %>% filter(session == "baseline", variable == "trr_05", grepl("PFC", roi_nm)) %>% arrange(-(rda+uv))
example_rois <- c(
  "17Networks_LH_ContA_PFCl_2",
  "17Networks_RH_ContA_PFCl_1",
  "17Networks_RH_ContA_PFCl_2",
  "17Networks_RH_ContA_PFCl_3",
  "17Networks_LH_DorsAttnA_SPL_2",
  "17Networks_LH_DorsAttnA_SPL_3",
  "17Networks_LH_DorsAttnA_SPL_6",
  "17Networks_LH_ContA_IPS_5"
)

p_brain_eg <-
  ggplot() +
  geom_brain(mapping = aes(fill = region %in% example_rois), atlas = atlas, side = "lateral") +
  theme_surface +
  theme_void() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "white"))
p_brain_eg

response_labs <- data.frame(
  label = c("multivariate", "\nunivariate"),
  response = names(colors_response),
  roi_nm = example_rois[example_rois == "17Networks_LH_ContA_IPS_5"]
)

p_eg <-
  s_hbm_posterior[roi_nm %in% example_rois & session == "baseline"] %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_density(size = 1.5, aes(fill = NULL, group = response)) +
  geom_vline(
    data = r_summarystat %>% filter(roi_nm %in% example_rois, session == "baseline") %>% .[, c("roi_nm", "r", "model_nm", "response")],
    aes(xintercept = r, color = response),
    linetype = "dotted", size = 1
    ) +
  facet_wrap(
    vars(gsub("17Networks_", "", roi_nm)), ncol = 4,
    ) +
  geom_text(data = response_labs, aes(x = -0.9, y = 6, label = label), size = 5, hjust = 0, fontface = "bold") +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability of Stroop contrast", y = "posterior density")
p_eg

p <- p_brain_eg + p_eg + plot_layout(nrow = 2, heights = c(1/2, 1))
p
ggsave(here("figs", "trr", "example_rois_trr_density_8.pdf"), p, dev = "pdf", width = 8, height = 5)


p_shrinkage_eg <-
  s_subj[roi_nm %in% example_rois & session == "baseline"] %>%
  #s_subj[roi_nm %in% rois[get_network(rois) == "ContA"] & session == "baseline"] %>%
  ggplot(aes(wave1, wave2)) +
  geom_abline(size = 0.5) +
  geom_hline(yintercept = 0, size = 0.5) +
  geom_vline(xintercept = 0, size = 0.5) +
  stat_ellipse(data = . %>% filter(model_nm == "summarystat"), type = "norm", alpha = 0.5, color = colors_models["summarystat"]) +
  stat_ellipse(data = . %>% filter(model_nm == "no_lscov_symm"), type = "norm", alpha = 0.5, color = colors_models["no_lscov_symm"]) +
  geom_point(aes(color = model_nm, shape = model_nm, fill = model_nm), size = 1) +
  scale_shape_manual(values = c(summarystat = 4, no_lscov_symm = 21)) +
  scale_color_manual(values = colors_models) +
  scale_fill_manual(values = colors_models) +
  geom_line(aes(group = subj), size = 0.5, color = "grey40") +
  theme(legend.position = "none") +
  facet_grid(
    rows = vars(roi_nm),
    cols = vars(response), scales = "free",
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"), roi_nm = example_roi_names)
    ) +
  labs(x = "test contrast", y = "retest contrast")

p_shrinkage_eg


#s_hbm_posterior[roi_nm %in% rois[get_network(rois) %in% c("ContA", "DorsAttnA")] & session == "baseline"] %>%
s_hbm_posterior[roi_nm %in% example_rois & session == "baseline"] %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_density(size = 1, aes(fill = NULL, group = response)) +
  # geom_vline(
  #   data = r_summarystat %>% filter(roi_nm %in% example_rois) %>% .[, c("roi_nm", "r", "model_nm", "response")],
  #   aes(xintercept = r, color = response),
  #   linetype = "dotted"
  #   ) +
  facet_wrap(
    vars(roi_nm),
    #labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))
    ) +
  # facet_grid(
  #   rows = vars(response),
  #   labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))
  # ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability", y = "density")

p_eg <- p_trrpost_eg + plot_layout(ncol = 2, widths = c(6/10, 4/10))

dir.create(here("figs", "trr"), showWarnings = FALSE)
ggsave(here("figs", "trr", "example_rois_trr_density.pdf"), p_trrpost_eg, dev = "pdf", width = 3, height = 3)
ggsave(here("figs", "trr", "example_rois_shrinkage.pdf"), p_shrinkage_eg, dev = "pdf", width = 4, height = 3)
ggsave(here("figs", "trr", "example_rois_surface.pdf"), p_brain_eg, dev = "pdf", width = 2, height = 2)

# s_hbm_posterior[roi_nm %in% example_rois[1]] %>%
#   ggplot(aes(trr, color = response, fill = response)) +
#   geom_density(size = 1, aes(fill = NULL)) +
#   geom_point(
#     data = r_summarystat %>% filter(roi_nm %in% example_rois) %>% .[, c("roi_nm", "r", "model_nm", "response")],
#     aes(x = r, y = 0, color = response), size = 2, shape = 4
#     ) +
#   geom_text(data = response_labs, aes(label = label, x = -0.5, y = 2), hjust = 0, fontface = "bold") +
#   facet_grid(
#     rows = vars(session),
#     labeller = labeller(roi_nm = example_roi_names)
#   ) +
#   scale_color_manual(values = colors_response) +
#   scale_fill_manual(values = colors_response) +
#   theme(legend.position = "none") +
#   labs(x = "test-retest reliability", y = "density")


```







```{r}
response_labs <- data.frame(
  label = c("univariate", "\nmultivariate"),
  response = names(colors_response),
  roi_nm = example_rois[2]
)
alpha_level <- 1/3

p_trrpost_network4 <-
  s_hbm_posterior %>%
  filter(network %in% c("Cont", "DorsAttn", "SalVentAttn", "Limbic"), session == "baseline") %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_line(size = 0.5, alpha = alpha_level, aes(group = roi_nm, fill = NULL), stat = "density") +
  geom_point(
    data =
        r_summarystat %>%
        mutate(network = get_network(roi_nm, TRUE)) %>%
        filter(network %in% c("Cont", "DorsAttn", "SalVentAttn", "Limbic")) %>%
        select(roi_nm, r, model_nm, response, network),
    aes(x = r, y = 0, color = response), size = 0.5, shape = 4, alpha = alpha_level
    ) +
  facet_grid(
    rows = vars(response),
    cols = vars(network),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"), roi_nm = example_roi_names)
  ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability", y = "density")

p_trrpost_network4

ggsave(here("figs", "trr", "posterior_network4.pdf"), p_trrpost_network4, dev = "pdf", width = 7, height = 7/4*2)

```



## all parcels

```{r}

response_labs <- data.frame(
  label = c("univariate", "\nmultivariate"),
  response = names(colors_response),
  roi_nm = example_rois[2]
)
alpha_level <- 1/3

p_trrpost_network4 <-
  s_hbm_posterior %>%
  filter(network %in% c("Cont", "DorsAttn", "SalVentAttn", "Limbic"), session == "baseline") %>%
  ggplot(aes(trr, color = response, fill = response)) +
  geom_line(size = 0.5, alpha = alpha_level, aes(group = roi_nm, fill = NULL), stat = "density") +
  geom_point(
    data =
        r_summarystat %>%
        mutate(network = get_network(roi_nm, TRUE)) %>%
        filter(network %in% c("Cont", "DorsAttn", "SalVentAttn", "Limbic")) %>%
        select(roi_nm, r, model_nm, response, network),
    aes(x = r, y = 0, color = response), size = 0.5, shape = 4, alpha = alpha_level
    ) +
  facet_grid(
    rows = vars(response),
    cols = vars(network),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"), roi_nm = example_roi_names)
  ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  theme(legend.position = "none") +
  labs(x = "test-retest reliability", y = "density")

p_trrpost_network4

ggsave(here("figs", "trr", "posterior_network4.pdf"), p_trrpost_network4, dev = "pdf", width = 7, height = 7/4*2)

## compare marginal with conditional

## create 2-d density plot with ggplot2, using trr and trr_conditional as x and y
## variables, and color as the density
# s_hbm_posterior %>%
#   filter(network %in% c("Cont"), session == "baseline" & roi_nm == "17Networks_LH_ContA_PFCl_2") %>%
#   ggplot(aes(trr, trr_conditional)) +
#   stat_density_2d(geom = "raster", aes(fill = after_stat(density)), contour = FALSE) +
#   geom_abline(color = "grey") +
#   scale_fill_viridis_c(option = "magma") +
#   labs(x = "marginal", y = "conditional") +
#   facet_grid(vars(response), vars(roi_nm))

```

## statistics on posteriors


```{r}

s_hbm_posterior_sum <-
  s_hbm_posterior[,
  .(
    trr_map = max_aposteriori(trr),
    trr_mean = mean(trr),
    trr_05 = quantile(trr, 0.05),
    trr_sd = sd(trr)
  ),
  by = c("model_nm", "roi_nm", "response", "network", "session")
  ]
s_hbm_posterior_sum <- melt(
  s_hbm_posterior_sum,
  id.vars = c("model_nm", "roi_nm", "response", "network", "session")
  )
s_hbm_posterior_sum$network <- get_network(s_hbm_posterior_sum$roi_nm, get_8 = TRUE)
s_hbm_posterior_sum_w <- s_hbm_posterior_sum %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "network", "session", "model_nm", "variable"),
    names_from = "response", values_from = "value"
    )

p_trr_sum <- list()
for (session_val in sessions) {

  p_trr_sum[[paste0("scatter_", session_val)]] <-
    s_hbm_posterior_sum_w %>%
    filter(variable %in% c("trr_map", "trr_mean", "trr_05"), session == session_val) %>%
    ggplot(aes(uv, rda, fill = network)) +
    geom_abline(linetype = "dotted") +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 1.5) +
    facet_grid(cols = vars(variable), labeller = labeller(variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile"))) +
    scale_fill_discrete_qualitative(palette = "Dark 3") +
    scale_color_discrete_qualitative(palette = "Dark 3") +
    scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
    theme(legend.position = "none") +
    labs(x = "univariate TRR", y = "multivariate TRR")

  p_trr_sum[[paste0("scatter_thresh_network3_", session_val)]] <-
    s_hbm_posterior_sum_w %>%
    filter(variable %in% c("trr_map", "trr_mean", "trr_05"), session == session_val) %>%
    ggplot(aes(uv, rda, fill = network)) +
    geom_abline(linetype = "dotted") +
    geom_hline(yintercept = 0.7, linetype = "dotted") +
    geom_vline(xintercept = 0.7, linetype = "dotted") +
    geom_point(aes(shape = roi_nm %in% example_rois, alpha = network %in% c("Cont", "DorsAttn", "SalVentAttn")), color = "white", size = 1.5) +
    facet_grid(cols = vars(variable), labeller = labeller(variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile"))) +
    scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = 0.1)) +
    scale_fill_discrete_qualitative(palette = "Dark 3") +
    scale_color_discrete_qualitative(palette = "Dark 3") +
    scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
    theme(legend.position = "none") +
    labs(x = "univariate TRR", y = "multivariate TRR")

  p_trr_sum[[paste0("brain_", session_val)]] <-
    s_hbm_posterior_sum %>%
    filter(session == session_val, variable %in% c("trr_map", "trr_mean", "trr_05")) %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    group_by(variable, response) %>%
    ggplot() +
    geom_brain(mapping = aes(fill = value), atlas = atlas, position = position_brain(. ~ hemi + side)) +
    scale_fill_viridis_c(
        option = "magma", na.value = "white",
        limits = c(0, 1), breaks = c(0, 0.5, 1)
        ) +
    theme_surface +
    facet_grid(
      vars(variable), vars(response),
      labeller = labeller(
        response = c(uv = "univariate", rda = "multivariate"),
        variable = c(trr_map = "MAP", trr_mean = "mean", trr_05 = "5th %tile")
        )) +
    theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/3)) +
    labs(fill = "TRR")

  dir.create(here("figs", "trr"), showWarnings = FALSE)
  ggsave(
    here("figs", "trr", paste0("scatter_", session_val, ".pdf")),
    p_trr_sum[[paste0("scatter_", session_val)]],
    dev = "pdf", width = 8, height = 8/3
    )
  ggsave(
    here("figs", "trr", paste0("scatter_thresh_network3_", session_val, ".pdf")),
    p_trr_sum[[paste0("scatter_thresh_network3_", session_val)]],
    dev = "pdf", width = 8, height = 8/3
    )
  ggsave(
    here("figs", "trr", paste0("brain_", session_val, ".pdf")),
    p_trr_sum[[paste0("brain_", session_val)]],
    dev = "pdf", width = 8, height = 3
    )

}

p_trr_sum

## sd (all sessions)

p_trrsd_scatter <-
  s_hbm_posterior_sum_w %>%
  filter(variable == "trr_sd") %>%
  ggplot(aes(uv, rda, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 1.5) +
  facet_grid(cols = vars(session)) +
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  theme(legend.position = "none") +
  labs(x = "sd(TRR_univ.)", y = "sd(TRR_multiv.)")
p_trrsd_scatter

p_trrsd_brain <-
    s_hbm_posterior_sum %>%
    filter(variable %in% c("trr_sd")) %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    group_by(session, response) %>%
    ggplot() +
    geom_brain(mapping = aes(fill = value), atlas = atlas, position = position_brain(. ~ hemi + side)) +
    scale_fill_viridis_c(
        option = "magma", na.value = "white"
        ) +
    theme_surface +
    facet_grid(
      vars(session), vars(response),
      labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))) +
    theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/3)) +
    labs(fill = "sd(TRR)")

p_trrsd_brain

ggsave(
  here("figs", "trr", "scatter_sd.pdf"),
  p_trrsd_scatter,
  dev = "pdf", width = 8, height = 8/3
  )
ggsave(
  here("figs", "trr", "brain_sd.pdf"),
  p_trrsd_brain,
  dev = "pdf", width = 8, height = 3
  )

```

# variance ratios


```{r}

s_hbm_subj_ratio <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(x) {
    ranefs <- ranef(x, summary = FALSE)$subj
    if ("sd_subj__hilo_wave1" %in% variables(x)) {
      stroop1 <- ranefs[, , "hilo_wave1"]
      stroop2 <- ranefs[, , "hilo_wave2"]
      if ("b_sigma_Intercept" %in% variables(x))  {
        hyp <- "exp(sigma_Intercept) = 0"
      } else {
        hyp <- "exp((sigma_mean_wave1 + sigma_mean_wave2) / 2) = 0"
      }
    } else {
      stroop1 <- ranefs[, , "hi_wave1"] - ranefs[, , "lo_wave1"]
      stroop2 <- ranefs[, , "hi_wave2"] - ranefs[, , "lo_wave2"]
      hyp <- "exp((sigma_hi_wave1 + sigma_hi_wave2 + sigma_lo_wave1 + sigma_lo_wave2) / 4) = 0"
    }
    sigma_stroop1 <- sqrt(Var(stroop1, 1))
    sigma_stroop2 <- sqrt(Var(stroop2, 1))
    sigma_stroop <- (sigma_stroop1 + sigma_stroop2)/2
    sigma_resid <- hypothesis(x, hyp)$samples$H1
    ratio <- sigma_resid / sigma_stroop

    data.table(
      sigma_resid = sigma_resid, 
      sigma_stroop = sigma_stroop, 
      ratio = sigma_resid / sigma_stroop,
      resample = seq_along(ratio)
      )

  }
)

s_hbm_subj_ratio <- s_hbm_subj_ratio %>% mutate(network = get_network(roi_nm))

```
## sd(trr)

```{r}

s_hbm_sdtrr <- future_pmap_bind(
  model_info,
  read_summarize_hbm,
  base_path = file.path(path_out, "inferential"),
  atlas_nm = atlas_nm,
  sum_fun = function(mdl) {
    mu <- ranef(mdl, summary = FALSE)$subj  ## for conditional TRR
    S <- VarCorr(mdl, summary = FALSE)$subj  ## for marginal TRR
    if ("sd_subj__hilo_wave1" %in% variables(mdl)) {
      mu_stroop1 <- mu[, , "hilo_wave1"]
      mu_stroop2 <- mu[, , "hilo_wave2"]
      trr <- S$cor[, "hilo_wave1", "hilo_wave2"]
    } else {
      mu_stroop1 <- mu[, , "hi_wave1"] - mu[, , "lo_wave1"]
      mu_stroop2 <- mu[, , "hi_wave2"] - mu[, , "lo_wave2"]
      trr <- NA  ## marginal ranefs not yet implemented for this parameterization
    }
    trr_conditional <- rep(0, dim(mu)[1])
    for (ii in seq_along(trr_conditional)) trr_conditional[ii] <- cor(mu_stroop1[ii, ], mu_stroop2[ii, ])
    stopifnot(length(trr_conditional) == length(trr))
    data.table(trr = trr, sd_trr = sd(trr), trr_conditional = trr_conditional, resample = seq_along(trr))
  }
)

s_hbm_sdtrr[, network := get_network(roi_nm, TRUE)]

s <- s_hbm_subj_ratio[s_hbm_sdtrr, on = c("roi_nm", "session", "response", "resample")]

p <-
  s[,
    .(ratio = max_aposteriori(ratio), sd_trr = unique(sd_trr)),
    by = c("model_nm", "roi_nm", "response", "network", "session")
    ] %>%
  filter(session == "baseline") %>%
  pivot_wider(names_from = response, values_from = c("ratio", "sd_trr")) %>%
  mutate(
    network = get_network(roi_nm, TRUE),
    sd_trr_mv_uv =  sd_trr_uv / sd_trr_rda,
    rv_mv_uv = ratio_uv / ratio_rda
    ) %>%
  #ggplot(aes(rv_mv_uv, sd_trr_mv_uv), fill = "black") +
  ggplot(aes(rv_mv_uv, sd_trr_mv_uv)) +
  #geom_abline(linetype = "dotted") +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_vline(xintercept = 1, linetype = "dotted") +
  geom_point(shape = 21, color = "white", size = 4, fill = "black", alpha = 3/4) +
  #facet_grid(cols = vars(session)) +
  scale_fill_identity() +
  #scale_fill_discrete_qualitative(palette = "Dark 3") +
  #scale_color_discrete_qualitative(palette = "Dark 3") +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  theme(legend.position = "none") +
  labs(x = "Multiv. Variab. Ratio / Univ. Variab. Ratio", y = "SD(multiv. TRR) / SD(univ. TRR)")
ggsave(
  here("figs", "trr", "scatter_ratio_sdtrr.pdf"),
  p,
  dev = "pdf", width = 4, height = 4
  )


```



```


```{r}

p_ratio_eg <- 
  s_hbm_subj_ratio[roi_nm %in% example_rois & session == "baseline"] %>%
  ggplot(aes(ratio, color = response, fill = response)) +
  geom_density(size = 1.5, aes(fill = NULL)) +
  facet_grid(
    rows = vars(roi_nm),
    labeller = labeller(roi_nm = example_roi_names)
  ) +
  scale_color_manual(values = colors_response) +
  scale_fill_manual(values = colors_response) +
  scale_x_continuous(trans = "log", limits = c(1.1, 55), breaks = c(1:5, 20, 50)) +
  theme(legend.position = "none") +
  labs(x = "Variability ratio (subject/trial)", y = "density")
p_ratio_eg

p_ratio_scatter <-
  s_hbm_subj_ratio[,
    .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network", "session")
    ] %>%
  pivot_wider(names_from = response, values_from = ratio) %>%
  mutate(network = get_network(roi_nm, TRUE)) %>%
  ggplot(aes(uv, rda, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 1.5) +
  facet_grid(cols = vars(session)) +
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  theme(legend.position = "none") +
  labs(x = "univariate", y = "multivariate")

p_ratio_scatter

p_ratio_brain <-
    s_hbm_subj_ratio[,
      .(ratio = max_aposteriori(ratio)), by = c("model_nm", "roi_nm", "response", "network", "session")
      ] %>%
    as.data.frame %>%
    rename(region = "roi_nm") %>%
    group_by(session, response) %>%
    ggplot() +
    geom_brain(mapping = aes(fill = ratio), atlas = atlas, position = position_brain(. ~ hemi + side)) +
    scale_fill_viridis_c(
        option = "magma", na.value = "white"
        ) +
    theme_surface +
    facet_grid(
      vars(session), vars(response),
      labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))) +
    theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/3)) +
    labs(fill = "R_v")

p_ratio_brain

ggsave(here("figs", "trr", "example_rois_ratio_density.pdf"), p_ratio_eg, dev = "pdf", width = 3, height = 3)
ggsave(
  here("figs", "trr", "scatter_ratio.pdf"),
  p_ratio_scatter,
  dev = "pdf", width = 8, height = 8/3
  )
ggsave(
  here("figs", "trr", "brain_ratio.pdf"),
  p_ratio_brain,
  dev = "pdf", width = 8, height = 3
  )



```

# scratch ----




### impact of HBMs

```{r}

s_pop %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave", "response"),
    names_from = "model_nm", values_from = "Estimate") %>%
  mutate(rmse = sqrt((no_lscov_symm - summarystat)^2)) %>%
  group_by(session, response, wave) %>%
  mutate(rmse_s = rmse / sd(rmse)) %>%
  ungroup %>%
  ggplot(aes(rmse_s)) +
  geom_histogram()

check_these_rois <-
  s_pop %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave", "response"),
    names_from = "model_nm", values_from = "Estimate") %>%
  mutate(rmse = sqrt((no_lscov_symm - summarystat)^2)) %>%
  group_by(session, response, wave) %>%
  mutate(rmse_s = rmse / sd(rmse)) %>%
  ungroup %>%
  filter(rmse_s > 6) %>% pull(roi_nm) %>% unique



s_pop %>%
  filter(response == "rda") %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave)) +
  geom_text(aes(label = roi_nm), size = 4, hjust = 1)

s_pop %>%
  filter(response == "uv") %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave)) +
  geom_text(aes(label = roi_nm), size = 4, hjust = 0)

s_pop %>%
  filter(response == "rda") %>%
  slice_max(Est.Error, n = 10)
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Est.Error"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave)) +
  geom_text(aes(label = roi_nm), size = 4, hjust = 0)


s_pop %>%
  filter(response == "uv") %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Est.Error"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave)) +
  geom_text(aes(label = roi_nm), size = 3, hjust = 1)


s_pop %>%
  filter(response == "rda") %>%
  mutate(Estimate = Estimate / Est.Error) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave))

s_pop %>%
  filter(response == "uv") %>%
  mutate(Estimate = Estimate / Est.Error) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  ggplot(aes(no_lscov_symm, summarystat, fill = network)) +
  geom_abline(linetype = "dotted") +
  geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  #geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  #scale_fill_manual(values = colors_network8) +
  #scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  #scale_color_identity() +
  labs(x = "HBM", y = "summary statistic", fill = NULL) +
  theme(legend.position = "none") +
  facet_grid(vars(session), vars(wave))

s_pop %>%
  mutate(Estimate = Estimate / Est.Error) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave", "response"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  mutate(diff = no_lscov_symm - summarystat) %>%
  ggplot(aes(interaction(session, wave), diff)) +
  #geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_boxplot() +
  facet_grid(vars(response))

s_pop %>%
  filter(response == "uv") %>%
  mutate(Estimate = Estimate / Est.Error) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "wave"), names_from = "model_nm", values_from = "Estimate"
    ) %>%
  mutate(diff = no_lscov_symm - summarystat) %>%
  ggplot(aes(interaction(session, wave), diff)) +
  #geom_point(aes(fill = network), color = "white", size = 3, shape = 21) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_boxplot()


```




## baseline

```{r}

p_fixed_baseline_scatter <-
  s_pop %>%
  filter(session == "baseline", model_nm == "no_lscov_symm") %>%
  mutate(stat = Estimate/Est.Error, network = get_network(roi_nm, get_8 = TRUE)) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "model_nm"), names_from = "response", values_from = "stat"
    ) %>%
  ggplot(aes(uv, rda, fill = network)) +
  geom_hline(yintercept = 2, linetype = "dotted") +
  geom_vline(xintercept = c(2, -2), linetype = "dotted") +
  geom_abline(linetype = "dotted") +
  geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 3) +
  geom_text(data = legend_network8, aes(label = label, color = color, x = -5, y = 7), hjust = 0, fontface = "bold") +
  scale_fill_manual(values = colors_network8) +
  scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  scale_color_identity() +
  labs(x = "tstat(univariate contrast)", y = "tstat(multivariate contrast)", fill = NULL) +
  theme(legend.position = "none")

p_fixed_baseline_scatter

p_fixed_baseline_brain <-
  s_pop %>%
  filter(model_nm == "no_lscov_symm", session == "baseline") %>%
  as.data.frame %>%
  rename(region = "roi_nm") %>%
  mutate(t = Estimate/Est.Error) %>%
  group_by(session, response) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = t), atlas = atlas, position = position_brain(. ~ hemi + side)) +
  scale_fill_viridis_c(
      option = "magma", na.value = "grey",
      limits = c(-6.5, 8.5)
      ) +
  theme_surface +
  facet_grid(
    vars(response),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))) +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank())

p_fixed_baseline_brain

dir.create(here("figs", "fixed"), showWarnings = FALSE)
ggsave(here("figs", "fixed", "baseline_scatter.pdf"), p_fixed_baseline_scatter, dev = "pdf", width = 5, height = 5)
ggsave(here("figs", "fixed", "baseline_brain.pdf"), p_fixed_baseline_brain, dev = "pdf", width = 8, height = 3)


```

```{r}

# rois_top10 <-
#   s_pop[roi_nm %in% rois_t2 & session == "baseline" & model_nm == "no_lscov_symm"] %>%
#   group_by(response) %>%
#   slice_max(Estimate/Est.Error, n = 5) %>%
#   pull(roi_nm) %>%
#   unique %>%
#   sort

p_fixed_all_scatter <- s_pop %>%
  filter(model_nm == "no_lscov_symm") %>%
  mutate(stat = Estimate/Est.Error, network = get_network(roi_nm, get_8 = TRUE)) %>%
  pivot_wider(
    id_cols = c("roi_nm", "network", "session", "model_nm"), names_from = "response", values_from = "stat"
    ) %>%
  ggplot(aes(uv, rda, fill = network)) +
  geom_hline(yintercept = 2, linetype = "dotted") +
  geom_vline(xintercept = c(2, -2), linetype = "dotted") +
  geom_abline(linetype = "dotted") +
  geom_point(aes(shape = roi_nm %in% example_rois), color = "white", size = 1.5) +
  facet_grid(cols = vars(session)) +
  theme(legend.position = "none") +
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_shape_manual(values = c(`TRUE` = 25, `FALSE` = 21)) +
  labs(x = "tstat(univariate contrast)", y = "tstat(multivariate contrast)")

p_fixed_all_scatter

p_fixed_all_brain <- s_pop %>%
  filter(model_nm == "no_lscov_symm") %>%
  as.data.frame %>%
  rename(region = "roi_nm") %>%
  mutate(t = Estimate/Est.Error) %>%
  group_by(session, response) %>%
  ggplot() +
  geom_brain(mapping = aes(fill = t), atlas = atlas, position = position_brain(. ~ hemi + side)) +
  scale_fill_viridis_c(
      option = "magma", na.value = "grey",
      limits = c(-6.5, 8.5)
      ) +
  theme_surface +
  facet_grid(
    vars(session), vars(response),
    labeller = labeller(response = c(uv = "univariate", rda = "multivariate"))) +
  theme(axis.line.x.bottom = element_blank(), axis.line.y.left = element_blank(), legend.position = c(0.5, 1/3))

p_fixed_all_brain

ggsave(here("figs", "fixed", "allsession_scatter.pdf"), p_fixed_all_scatter, dev = "pdf", width = 8, height = 8/3)
ggsave(here("figs", "fixed", "allsession_brain.pdf"), p_fixed_all_brain, dev = "pdf", width = 8, height = 3)


```



<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>



